<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Ultimate AI)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS STYLE */
        :root { --bg: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%); --c-bg: #ffffff; --txt: #1e293b; --txt-l: #475569; --p: #2563eb; --border: #cbd5e1; --green-active: #10b981; }
        body.dark-mode { --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); --c-bg: #1e293b; --txt: #f1f5f9; --txt-l: #cbd5e1; --border: #475569; --green-active: #059669; }
        * { font-family: 'Sarabun', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); padding: 20px; color: var(--txt); transition: 0.3s; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--c-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border); position: relative; }
        .theme-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: var(--c-bg); color: var(--txt); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 100; }
        
        .lotto-header { text-align: center; margin-bottom: 20px; }
        .lotto-selector-group { display: inline-flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 5px 15px; border-radius: 50px; border: 1px solid var(--border); margin-top: 10px; }
        body.dark-mode .lotto-selector-group { background: #334155; }
        select#lottoSelector { border: none; background: transparent; font-size: 16px; font-weight: 700; color: var(--p); cursor: pointer; outline: none; }
        
        .input-section { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .input-box-main { flex: 1.5; min-width: 300px; }
        .input-box-add { flex: 1; min-width: 250px; background: #f0f9ff; padding: 20px; border-radius: 15px; border: 1px solid #bae6fd; display: flex; flex-direction: column; }
        body.dark-mode .input-box-add { background: #172554; border-color: #1e40af; }
        textarea { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px; resize: vertical; background: var(--c-bg); color: var(--txt); font-size: 16px; font-weight: 500; }
        .history-area { height: 150px; } .add-area { height: 100px; }
        .label-head { font-weight: 800; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; color: var(--p); font-size: 18px; }
        .db-counter { background: #3b82f6; color: white; font-size: 12px; padding: 2px 8px; border-radius: 10px; margin-left: 5px; font-weight: 600; }
        .btn { padding: 5px 15px; border-radius: 20px; border: 1px solid var(--border); background: var(--c-bg); color: var(--txt-l); cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 14px; }
        .btn:hover { transform: translateY(-1px); }
        .btn.active { background: var(--p); color: white; border-color: var(--p); }
        .btn-add { width: 100%; margin-top: 10px; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 16px; }

        .collapsible-container { border-radius: 15px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; background: var(--c-bg); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .collapsible-header { padding: 15px; background: #f1f5f9; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; color: var(--txt); border-bottom: 1px solid var(--border); }
        body.dark-mode .collapsible-header { background: #334155; }
        .collapsible-content { padding: 20px; display: block; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        
        .flow-section, .structure-section { background: var(--c-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--border); }
        .flow-grid-wrapper, .struct-grid-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start; }
        .flow-card, .struct-card { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--c-bg); }
        .flow-header { padding: 6px 10px; font-weight: 700; color: white; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .flow-body, .struct-body { padding: 10px; text-align: center; }
        .flow-num-row { font-size: 18px; font-weight: 700; letter-spacing: 2px; margin-bottom: 5px; }
        
        .bg-hundred { background: #ef4444; } .bg-tens-up { background: #f97316; } .bg-units-up { background: #eab308; color:black!important; } 
        .bg-up-all { background: #84cc16; } .bg-tens-down { background: #06b6d4; } .bg-units-down { background: #3b82f6; } .bg-down-all { background: #6366f1; } .bg-all { background: #a855f7; }
        .bg-sum-top { background: #be185d; } .bg-sum-bot { background: #0369a1; }
        
        .smart-flow-box { border: 2px dashed #f59e0b; border-radius: 15px; padding: 20px; background: #fffbeb; margin-top: 20px; }
        body.dark-mode .smart-flow-box { background: #451a03; border-color: #d97706; }
        .sf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap:10px; }
        .sf-controls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .sf-btn { background: #d97706; color: white; border: none; padding: 6px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(217, 119, 6, 0.3); }
        .sf-btn:hover { background: #b45309; }
        .sf-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-top: 15px; }
        .sf-card { background: var(--c-bg); border: 1px solid var(--border); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: 400px; }
        .sf-card-header { font-weight: 800; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #b45309; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }
        .sf-card-body { flex: 1; overflow-y: auto; font-family: monospace; font-size: 13px; line-height: 1.5; color: var(--txt); background: rgba(0,0,0,0.02); padding: 5px; border-radius: 5px; white-space: pre-wrap; }
        .sf-card-footer { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-copy-sf { background: var(--c-bg); border: 1px solid var(--p); color: var(--p); padding: 2px 8px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: bold; }
        
        .control-panel { border-top: 2px solid var(--border); padding-top: 20px; }
        .display-mode-group { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; align-items: center; flex-wrap: wrap; }
        .hunt-toggle-group { display: flex; gap: 10px; justify-content: center; background: #fff7ed; padding: 8px; border-radius: 50px; width: fit-content; margin: 10px auto; border: 1px solid #ffedd5; }
        body.dark-mode .hunt-toggle-group { background: #451a03; border-color: #7c2d12; }
        .btn-hunt { padding: 6px 20px; border-radius: 30px; font-weight: 700; color: #9a3412; border: 1px solid transparent; background: transparent; cursor: pointer; font-size: 14px; }
        .btn-hunt.active { background: #f97316; color: white; }
        body.dark-mode .btn-hunt { color: #fdba74; }
        .btn-mode { padding: 8px 20px; border-radius: 50px; border: 1px solid var(--border); background: var(--c-bg); color: var(--txt); cursor: pointer; font-weight: 700; }
        .btn-mode.active { background: var(--p); color: white; }
        .manual-control { display: none; align-items: center; gap: 5px; font-size: 14px; }
        .page-btn { padding: 5px 15px; background: var(--p); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-weight: bold; color: var(--txt); font-size: 14px; }
        
        .settings-bar { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; background: #f8fafc; padding: 12px 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        body.dark-mode .settings-bar { background: #334155; border-color: #475569; }

        .pattern-bar { display: flex; gap: 10px; justify-content: center; background: #f1f5f9; padding: 10px; border-radius: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .pattern-bar { background: var(--c-bg); border: 1px solid var(--border); }
        body.dark-mode .pattern-bar { background: #334155; }
        
        .btn-step, .btn-len { padding: 5px 12px; border: 1px solid var(--border); border-radius: 15px; background: var(--c-bg); color: var(--txt-l); cursor: pointer; font-weight: 600; font-size: 13px; }
        .btn-step.active, .btn-len.active { background: #7c3aed; color: white; border-color: #7c3aed; }
        .btn-len.active { background: var(--p); border-color: var(--p); }

        .btn-sort { padding: 6px 12px; border: 1px solid var(--border); border-radius: 15px; cursor: pointer; font-size: 14px; font-weight: 700; background: var(--c-bg); color: var(--txt-l); }
        .btn-sort.active { background: #f59e0b; color: white; border-color: #f59e0b; }
        .btn-sort.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        
        .grid-targets { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 20px; }
        .btn-target { background: var(--c-bg); border: 1px solid var(--border); color: var(--txt-l); padding: 8px 10px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 700; white-space: nowrap; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-target:hover { transform: translateY(-2px); border-color: var(--green-active); color: var(--green-active); box-shadow: 0 4px 6px rgba(16, 185, 129, 0.15); }
        .btn-target.active { background: var(--green-active) !important; border-color: var(--green-active) !important; color: white !important; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); transform: translateY(-1px); }
        
        input[type=number], input[type=text] { padding: 5px; border-radius: 5px; border: 1px solid var(--border); text-align: center; background: var(--c-bg); color: var(--txt); width: 50px; font-size: 14px; font-weight: 600; }
        
        .table-wrapper { margin-top: 20px; width: 100%; border-radius: 15px; border: 1px solid var(--border); overflow: auto; position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 16px; white-space: nowrap; }
        th { background: #334155; color: white; padding: 12px; position: sticky; top: 0; z-index: 50; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th:first-child { left: 0; z-index: 60; background: #212529; border-right: 2px solid #475569; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); font-size: 18px; color: var(--txt); }
        td:first-child { position: sticky; left: 0; z-index: 40; background: #fef08a; font-weight: 800; color: black; border-right: 2px solid #cbd5e1; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        body.dark-mode td:first-child { background: #854d0e; color: #fef08a; border-color: #475569; }
        
        .stat-t { color: #16a34a; font-weight: 900; font-size: 1.2em; }
        .stat-f { color: #dc2626; font-weight: 900; font-size: 1.2em; }
        .hunt-tag { font-size: 12px; padding: 2px 6px; border-radius: 6px; margin-left: 3px; color: white; font-weight: 600; }
        .hunt-tag.win { background: #10b981; } .hunt-tag.wait { background: #f59e0b; }
        
        .vin-flow-section { margin-top: 20px; background: var(--c-bg); border: 1px solid var(--border); border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .vin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed var(--border); padding-bottom: 10px; margin-bottom: 15px; flex-wrap: wrap; gap:10px; }
        .vin-title { font-size: 18px; font-weight: 700; color: var(--txt); }
        .vin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 700px) { .vin-grid { grid-template-columns: 1fr; } }
        .vin-box { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .vin-head { padding: 10px; color: white; font-weight: 700; text-align: center; display: flex; justify-content: space-between; font-size: 15px; }
        .vin-body { padding: 15px; text-align: center; font-size: 16px; font-weight: 600; line-height: 1.5; word-wrap: break-word; color: var(--txt); }
        .bg-vin-up { background: linear-gradient(to right, #f59e0b, #d97706); }
        .bg-vin-down { background: linear-gradient(to right, #3b82f6, #2563eb); }
        .btn-tiny { background: rgba(255,255,255,0.25); border: none; color: white; cursor: pointer; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-family: 'Sarabun'; }
        .btn-star { background: none; border: none; cursor: pointer; font-size: 16px; color: #cbd5e1; margin-right: 4px; }
        .btn-star.pinned { color: #f59e0b; transform: scale(1.2); }
        .alert-bar { display: none; background-color: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 700; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 25px; border-radius: 50px; font-weight: 600; display: none; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-size: 14px; }
        .btn-copy-col { background: none; border: none; cursor: pointer; font-size: 14px; color: #cbd5e1; margin-left: 5px; transition: 0.2s; }
        .btn-copy-col:hover { color: #fcc419; transform: scale(1.2); }
        .table-footer-controls { display: none; justify-content: center; align-items: center; margin-top: 15px; gap: 15px; padding: 10px; background: #f1f5f9; border-radius: 10px; }
        body.dark-mode .table-footer-controls { background: #334155; }
        .manual-limit-input { width: 70px !important; margin-left: 5px; }
        .copy-container { margin-top:20px; text-align:center; }
        .btn-line { background: #10b981; color: white; border: none; padding: 10px 40px; border-radius: 50px; font-weight: 800; font-size: 16px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); cursor: pointer; }

        .num-match { color: #db2777; font-weight: 900; }
        .row-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #e2e8f0; padding: 2px 0; }
        body.dark-mode .row-line { border-color: #334155; }
        body.dark-mode .num-match { color: #f472b6; }
        .num-normal { opacity: 0.8; }

        /* Garland Matrix */
        .garland-wrapper { overflow-x: auto; overflow-y: hidden; position: relative; border-radius: 8px; border: 1px solid #cbd5e1; background: #ffffff; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .garland-table { width: 100%; border-collapse: separate; border-spacing: 0; white-space: nowrap; }
        .garland-table th, .garland-table td { padding: 6px 4px; text-align: center; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; font-size: 16px; font-family: 'Sarabun', sans-serif; color: #000000; }
        .garland-table thead th { position: sticky; top: 0; z-index: 20; background: #334155; color: white; font-weight: 600; box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        .garland-table td:nth-child(1), .garland-table th:nth-child(1) { position: sticky; left: 0; z-index: 10; background: #f8fafc; border-right: 2px solid #cbd5e1; font-weight: bold; color: #64748b; }
        .garland-table thead th:nth-child(1) { z-index: 30; background: #1e293b; color: white !important; }
        .garland-table td:nth-child(2), .garland-table th:nth-child(2) { position: sticky; left: 50px; z-index: 10; background: #ffffff; border-right: 2px solid #cbd5e1; color: #000000; font-weight: 800; }
        .garland-table thead th:nth-child(2) { z-index: 30; background: #1e293b; color: white !important; }
        .g-num-hit { color: #db2777; font-weight: 900; } 
        .g-cell-win { background-color: #dcfce7; }   

        .special-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; width: 100%; box-sizing: border-box; }
        .special-card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; text-align: center; height: 100%; transition: transform 0.2s; }
        .special-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="container">
    <button class="theme-btn" onclick="toggleTheme()">üåô</button>
    <div style="height:20px;"></div>
    <div id="alertBox" class="alert-bar"></div>
    
    <div class="lotto-header">
        <h2 style="margin-bottom:10px; font-weight:800; color:var(--txt);">üî¢ AI CALCULATOR <span style="font-size:12px; background:var(--p); color:white; padding:2px 8px; border-radius:10px;">ULTIMATE AI</span></h2>
        <div class="lotto-selector-group">
            <select id="lottoSelector" onchange="changeLottoType()">
                <option value="thai">üáπüá≠ ‡∏´‡∏ß‡∏¢‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•</option>
                <option value="lao">üá±üá¶ ‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß</option>
                <option value="hanoi">üáªüá≥ ‡∏´‡∏ß‡∏¢‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</option>
                <option value="yeekee">üé∞ ‡∏´‡∏ß‡∏¢‡∏¢‡∏µ‡πà‡∏Å‡∏µ</option>
                <option value="stock">üìà ‡∏´‡∏ß‡∏¢‡∏´‡∏∏‡πâ‡∏ô/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
            <span id="dbCount" class="db-counter">0 ‡∏á‡∏ß‡∏î</span>
            <button onclick="renameLotto()" class="btn" style="padding:2px 8px; font-size:12px; border:none; background:transparent;">‚úèÔ∏è</button>
        </div>
    </div>

    <div class="collapsible-container">
        <div class="collapsible-header" onclick="toggleSection('inputContent', 'inputIcon')">
            <span>üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span><span id="inputIcon">‚ñº</span>
        </div>
        <div id="inputContent" class="collapsible-content">
            <div class="input-section">
                <div class="input-box-main">
                    <div class="label-head"><span>üìö ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span><div><button onclick="toggleEditData()" id="btnEdit" class="btn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button> <button onclick="clearAll()" class="btn" style="color:#ef4444;">‡∏•‡πâ‡∏≤‡∏á</button></div></div>
                    <textarea id="inputData" class="history-area" placeholder="‡∏ß‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." readonly></textarea>
                </div>
                <div class="input-box-add">
                    <div class="label-head"><span>‚ûï ‡πÄ‡∏ï‡∏¥‡∏°‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà</span><button class="btn" id="btnOrder" onclick="toggleOrder()">‚¨á ‡∏õ‡∏Å‡∏ï‡∏¥</button></div>
                    <textarea id="newData" class="add-area"></textarea>
                    <button class="btn-add" onclick="appendAndRun()">‡πÄ‡∏û‡∏¥‡πà‡∏° + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                </div>
            </div>
        </div>
    </div>

    <div class="collapsible-container" style="margin-top: 20px;">
        <div class="collapsible-header" onclick="toggleSection('dashSmartFlow', 'dashIcon2')">
            <span>üìù ‡∏à‡∏±‡∏î‡∏ä‡∏∏‡∏î‡πÑ‡∏´‡∏• (Smart Flow Top 5)</span><span id="dashIcon2">‚ñº</span>
        </div>
        <div id="dashSmartFlow" class="collapsible-content">
            <div class="smart-flow-box" style="margin-top:0; border:none; box-shadow:none;">
                <div class="sf-header">
                    <span style="font-size:16px; font-weight:800; color:#b45309;">üìù ‡∏à‡∏±‡∏î‡∏ä‡∏∏‡∏î‡πÑ‡∏´‡∏• (Smart Flow Top 5)</span>
                    <div class="sf-controls">
                        <select id="sfTarget" class="btn" style="padding:4px;">
                            <option value="0">1. ‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢</option>
                            <option value="1">2. ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</option>
                            <option value="2">3. ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô</option>
                            <option value="3" selected>4. ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≠‡∏¢)</option>
                            <option value="4">5. ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á</option>
                            <option value="5">6. ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á</option>
                            <option value="6">7. ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á</option>
                            <option value="7">8. ‡∏ö‡∏ô+‡∏•‡πà‡∏≤‡∏á (‡∏£‡∏ß‡∏°)</option>
                            <option value="8">9. ‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏ô</option>
                            <option value="9">10. ‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á</option>
                            <option value="10">11. ‡∏ß‡∏¥‡∏ô‡∏ö‡∏ô (‡∏Ñ‡∏£‡∏ö 2 ‡∏ï‡∏±‡∏ß)</option>
                            <option value="11">12. ‡∏ß‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏Ñ‡∏£‡∏ö 2 ‡∏ï‡∏±‡∏ß)</option>
                        </select>
                        <span style="font-size:12px; font-weight:bold;">‡πÄ‡∏≠‡∏≤:</span>
                        <input type="number" id="sfLen" value="4" min="1" max="9" style="width:40px;" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç">
                        <span style="font-size:12px; font-weight:bold;">‡∏¢‡πâ‡∏≠‡∏ô:</span>
                        <input type="number" id="sfLookback" value="10" style="width:40px;" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î">
                        <button class="sf-btn" style="background:#16a34a; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.3);" onclick="genSmartFlow()">üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                        <button class="btn" onclick="copySmartFlow()">Copy All</button>
                    </div>
                </div>
                <div id="sfOutput" class="sf-grid-container"></div>
            </div>
        </div>
    </div>
    
    <div class="collapsible-container" style="margin-top: 20px;">
        <div class="collapsible-header" onclick="toggleSection('followContent', 'dashIcon3')">
            <span>üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏° (Cross-Position & High-Low)</span><span id="dashIcon3">‚ñº</span>
        </div>
        <div id="followContent" class="collapsible-content">
            <div class="smart-flow-box" style="margin-top:0; border:none; box-shadow:none; background:#f0fdf4; border:2px dashed #16a34a;">
                <div class="sf-header">
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:center;">
                        <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #dcfce7;">
                            <span style="font-weight:bold; color:#15803d;">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:</span>
                            <span style="font-size:14px;">‡∏ñ‡πâ‡∏≤</span>
                            <select id="followNum" class="btn" style="padding:2px 5px;">
                                <option value="0">0</option><option value="1">1</option><option value="2">2</option>
                                <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                <option value="6">6</option><option value="7">7</option><option value="8">8</option>
                                <option value="9">9</option>
                            </select>
                            <span style="font-size:14px;">‡∏°‡∏≤</span>
                            <select id="sourcePos" class="btn" style="padding:2px 5px;" onchange="autoFillInputs()">
                                <option value="0">‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢</option>
                                <option value="1" selected>‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</option>
                                <option value="2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô</option>
                                <option value="3">‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á</option>
                                <option value="4">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á</option>
                                <option value="5">‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏ô</option>
                                <option value="6">‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á</option>
                            </select>
                        </div>
                        <span style="font-size:20px; color:#16a34a;">üëâ</span>
                        <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #fef9c3;">
                            <span style="font-weight:bold; color:#b45309;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span>
                            <span style="font-size:14px;">‡∏î‡∏π</span>
                            <select id="targetPos" class="btn" style="padding:2px 5px; border-color:#b45309; color:#b45309;">
                                <option value="0">‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢</option>
                                <option value="1">‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</option>
                                <option value="2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô</option>
                                <option value="1" selected>‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</option>
                                <option value="4">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á</option>
                                <option value="5">‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏ô</option>
                                <option value="6">‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á</option>
                            </select>
                        </div>
                        <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #3b82f6; display:flex; align-items:center; gap:5px;">
                            <span style="font-weight:bold; color:#2563eb; font-size:13px;">‡∏£‡∏∞‡∏¢‡∏∞:</span>
                            <input type="number" id="followLookForward" value="3" min="1" max="10" class="btn" style="width:40px; padding:2px; color:#2563eb; border-color:#2563eb; text-align:center;">
                            <span style="font-size:12px;">‡∏á‡∏ß‡∏î</span>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="sf-btn" style="background:#16a34a;" onclick="calcFollowing()">üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                            <button class="sf-btn" style="background:#ffffff; color:#16a34a; border:1px solid #16a34a; box-shadow:none;" onclick="copyFollowResult()">üìã Copy</button>
                        </div>
                    </div>
                </div>
                <div id="hlPrediction" style="margin-top:15px; padding:10px; background:white; border-radius:10px; display:none; border:1px solid #e2e8f0; text-align:center;"></div>
                <div id="followOutput" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap:10px; margin-top:15px;"></div>
            </div>
        </div>

        <div class="collapsible-container" style="margin-top: 20px;">
            <div class="collapsible-header" onclick="toggleSection('pairFollowContent', 'dashIcon4')">
                <span>üë• ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (Pair Follow) 2 ‡∏ï‡∏±‡∏ß</span><span id="dashIcon4">‚ñº</span>
            </div>
            <div id="pairFollowContent" class="collapsible-content">
                <div class="smart-flow-box" style="margin-top:0; border:none; box-shadow:none; background:#ecfdf5; border:2px dashed #059669;">
                    <div class="sf-header">
                       <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center;">
                            <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #a7f3d0; display:flex; align-items:center; gap:5px;">
                                <span style="font-weight:bold; color:#059669; font-size:13px;">‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏π‡πà</span>
                                <select id="pairSourcePos" class="btn" style="padding:2px;">
                                    <option value="up">‡∏ö‡∏ô</option>
                                    <option value="down">‡∏•‡πà‡∏≤‡∏á</option>
                                </select>
                                <input type="number" id="pairInput" class="btn" style="width:50px; padding:2px;" placeholder="85">
                            </div>
                            <span style="font-size:16px; color:#059669;">üëâ</span>
                            <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #fef9c3; display:flex; align-items:center; gap:5px;">
                                <span style="font-size:13px;">‡∏î‡∏π‡∏Ñ‡∏π‡πà</span>
                                <select id="pairTargetPos" class="btn" style="padding:2px;">
                                    <option value="up">‡∏ö‡∏ô</option>
                                    <option value="down">‡∏•‡πà‡∏≤‡∏á</option>
                                </select>
                            </div>
                            <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #f59e0b; display:flex; align-items:center; gap:5px;">
                                <span style="font-weight:bold; color:#d97706; font-size:13px;">‡∏£‡∏∞‡∏¢‡∏∞:</span>
                                <input type="number" id="pairLookForward" value="3" min="1" max="10" class="btn" style="width:40px; padding:2px; color:#d97706; border-color:#d97706; text-align:center;">
                                <span style="font-size:12px;">‡∏á‡∏ß‡∏î</span>
                            </div>
                            <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #3b82f6; display:flex; align-items:center; gap:5px;">
                                <span style="font-weight:bold; color:#2563eb; font-size:13px;">‡πÄ‡∏≠‡∏≤:</span>
                                <input type="number" id="winLength" value="8" min="3" max="9" class="btn" style="width:40px; padding:2px; color:#2563eb; border-color:#2563eb;">
                                <span style="font-size:12px;">‡∏ï‡∏±‡∏ß</span>
                            </div>
                            <button class="sf-btn" style="background:#059669;" onclick="calcPairFollow()">üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                            <button class="sf-btn" style="background:#ffffff; color:#059669; border:1px solid #059669; box-shadow:none;" onclick="copyPairWinResult()">üìã Copy</button>
                       </div>
                    </div>
                    <div id="pairWinPrediction" style="margin-top:15px; display:none; grid-template-columns: 1fr; gap:10px;"></div>
                    <div id="pairHlPrediction" style="margin-top:10px; padding:10px; background:white; border-radius:10px; display:none; border:1px solid #e2e8f0; text-align:center;"></div>
                    <div id="pairTop10Action" style="display:none; justify-content:center; margin-top:15px; margin-bottom:5px;">
                        <button class="sf-btn" style="background:#4f46e5; padding:5px 15px; font-size:14px; box-shadow:0 2px 5px rgba(79, 70, 229, 0.3);" onclick="copyPairTop10()">
                            üìë ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å 10 ‡∏Ñ‡∏π‡πà‡πÄ‡∏î‡πà‡∏ô (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
                        </button>
                    </div>
                    <div id="pairOutput" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap:10px; margin-top:15px;"></div>
                </div>
            </div>

    <div class="collapsible-container" style="margin-top: 20px;">
        <div class="collapsible-header" onclick="toggleSection('deepFollowContent', 'dfIcon')">
            <span>üïµÔ∏è‚Äç‚ôÇÔ∏è ‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏° (Deep Follow Analysis)</span><span id="dfIcon">‚ñº</span>
        </div>
        <div id="deepFollowContent" class="collapsible-content">
            <div class="smart-flow-box" style="margin-top:0; border:none; box-shadow:none; background:#ecfdf5; border:2px dashed #059669;">
                <div class="sf-header">
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center;">
                        <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #a7f3d0; display:flex; align-items:center; gap:5px;">
                            <span style="font-weight:bold; color:#059669; font-size:13px;">‡∏ñ‡πâ‡∏≤</span>
                            <select id="dfSourcePos" class="btn" style="padding:2px;" onchange="autoFillInputs()">
                                <option value="0">‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢</option>
                                <option value="1" selected>‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</option>
                                <option value="2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô</option>
                                <option value="3">‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á</option>
                                <option value="4">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á</option>
                            </select>
                            <span style="font-weight:bold; color:#059669; font-size:13px;">‡∏°‡∏≤</span>
                            <select id="dfSourceNum" class="btn" style="padding:2px; width:50px;">
                                <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option>
                            </select>
                        </div>
                        <span style="font-size:16px; color:#059669;">üëâ</span>
                        <div style="background:rgba(255,255,255,0.6); padding:5px; border-radius:10px; border:1px solid #fef9c3; display:flex; align-items:center; gap:5px;">
                            <span style="font-size:13px; font-weight:bold; color:#b45309;">‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ</span>
                            <select id="dfTargetPos" class="btn" style="padding:2px;">
                                <option value="0">‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢</option>
                                <option value="1" selected>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</option>
                                <option value="2">‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô</option>
                                <option value="3">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á</option>
                                <option value="4">‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á</option>
                            </select>
                            <span style="font-size:13px; font-weight:bold; color:#b45309;">‡∏≠‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£?</span>
                        </div>
                        <button class="sf-btn" style="background:#059669;" onclick="calcDeepFollow()">üöÄ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                        <button class="sf-btn" style="background:#ffffff; color:#059669; border:1px solid #059669; box-shadow:none;" onclick="copyDeepFollowResult()">üìã Copy</button>
                    </div>
                </div>
                <div id="dfResultHeader" style="text-align:center; margin-top:20px; font-weight:bold; font-size:16px; color:#0f172a; display:none;"></div>
                <div id="dfOutput" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap:10px; margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div class="display-mode-group">
            <button class="btn-mode active" id="btnModeAuto" onclick="setMode('auto')">ü§ñ Auto (Top 5)</button>
            <button class="btn-mode" id="btnModeAll" onclick="setMode('all')">üìú Manual (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</button>
            <div id="manualControl" class="manual-control">
                <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏ï‡∏£: <input type="number" id="manualLimitInput" class="manual-limit-input" value="100" min="10" onchange="runProgram()"></span>
            </div>
        </div>

        <div class="hunt-toggle-group">
            <button class="btn-hunt active" id="btnHuntOff" onclick="setHunt(false)">üéØ ‡∏õ‡∏Å‡∏ï‡∏¥</button>
            <button class="btn-hunt" id="btnHuntOn" onclick="setHunt(true)">üî´ ‡∏•‡πà‡∏≤</button>
            <span id="huntInputWrap" style="display:none; align-items:center; margin-left:10px;">
                ‡∏ï‡∏≤‡∏° <input type="number" id="huntMax" value="3" style="width:40px;"> ‡∏á‡∏ß‡∏î
            </span>
        </div>

        <div style="text-align:center; margin-bottom:10px;">
            <button class="btn-sort active" id="sortScore" onclick="setSort('score')">üèÜ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</button>
            <button class="btn-sort" id="sortFixed" onclick="setSort('fixed')">üî§ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£ (‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)</button>
        </div>

        <div class="settings-bar" style="justify-content: center; gap: 15px; flex-wrap: wrap; background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 12px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 20px;">
            <div style="display:flex; align-items:center; gap:5px;">
                <span style="font-weight:700; color:#334155;">üìÖ ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                <input type="number" id="rangeCount" value="10" oninput="updateRangeFromCount()" style="width:50px; text-align:center; padding:4px; border:2px solid #cbd5e1; border-radius:6px; font-weight:bold; color:#1e3a8a;">
                <span style="font-size:13px; font-weight:700; color:#64748b;">‡∏á‡∏ß‡∏î</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px; border-left:2px solid #e2e8f0; padding-left:10px;">
                <span style="font-weight:700; color:#334155;">üîé ‡πÄ‡∏£‡∏¥‡πà‡∏°:</span>
                <input type="number" id="rangeStart" oninput="updateCountFromRange()" style="width:50px; text-align:center; padding:4px; border:2px solid #cbd5e1; border-radius:6px; font-weight:bold; color:#475569;">
                <span style="font-weight:700; color:#334155;">‡∏ñ‡∏∂‡∏á</span>
                <input type="number" id="rangeEnd" oninput="updateCountFromRange()" style="width:50px; text-align:center; padding:4px; border:2px solid #cbd5e1; border-radius:6px; font-weight:bold; color:#475569;">
            </div>
            <div style="display:flex; align-items:center; gap:5px; border-left:2px solid #e2e8f0; padding-left:10px;">
                <span style="color:#2563eb; font-weight:800;">‚è© ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</span>
                <input type="number" id="forwardTest" value="0" min="0" max="20" onchange="runProgram()" title="‡∏ï‡∏±‡∏î‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏≠‡∏Å X ‡∏á‡∏ß‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏π‡∏ï‡∏£" style="width:50px; text-align:center; padding:4px; border:2px solid #3b82f6; border-radius:6px; font-weight:bold; color:#1e3a8a;">
                <span style="font-size:13px; font-weight:700; color:#2563eb;">‡∏á‡∏ß‡∏î</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px; border-left:2px solid #e2e8f0; padding-left:10px;">
                <span style="color:#dc2626; font-weight:800;">‚õî ‡∏ú‡∏¥‡∏î ‚â§</span>
                <input type="number" id="maxLoss" placeholder="-" onkeyup="filterAndRender()" onchange="filterAndRender()" title="‡∏™‡∏π‡∏ï‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏¥‡∏î‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ô‡∏µ‡πâ" style="width:50px; text-align:center; padding:4px; border:2px solid #ef4444; border-radius:6px; font-weight:bold; color:#b91c1c;">
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <span style="color:#dc2626; font-weight:800;">üìâ ‡∏ã‡πâ‡∏≥ ‚â§</span>
                <input type="number" id="maxConsLoss" placeholder="-" onkeyup="filterAndRender()" onchange="filterAndRender()" title="‡∏™‡∏π‡∏ï‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ô‡∏µ‡πâ" style="width:50px; text-align:center; padding:4px; border:2px solid #ef4444; border-radius:6px; font-weight:bold; color:#b91c1c;">
            </div>
            <div style="display:flex; align-items:center; gap:5px; border-left:2px solid #e2e8f0; padding-left:10px;">
                <span style="color:#9333ea; font-weight:800;">‚úÇÔ∏è ‡∏ï‡∏±‡∏î‡πÄ‡∏•‡∏Ç:</span>
                <input type="text" id="killDigits" placeholder="‡πÄ‡∏ä‡πà‡∏ô 05" onchange="runProgram()" style="width:70px; text-align:center; padding:4px; border:2px solid #a855f7; border-radius:6px; font-weight:bold; color:#6b21a8;">
            </div>
            <input type="hidden" id="manualLimitInput" value="100">
        </div>

        <div class="pattern-bar" style="justify-content: space-between;">
            <div style="display:flex; gap:5px; align-items:center;">
                <span style="font-weight:bold; font-size:13px;">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:</span>
                <button class="btn-step active" onclick="setStep('normal', this)">‡πÄ‡∏£‡∏µ‡∏¢‡∏á</button>
                <button class="btn-step" onclick="setStep('odd', this)">‡∏Ñ‡∏µ‡πà</button>
                <button class="btn-step" onclick="setStep('even', this)">‡∏Ñ‡∏π‡πà</button>
                <button class="btn-step" onclick="setStep('step3', this)">‡∏Ç‡πâ‡∏≤‡∏°3</button>
                <button class="btn-step" onclick="setStep('step5', this)">‡∏Ç‡πâ‡∏≤‡∏°5</button>
            </div>
            <div style="display:flex; gap:3px; align-items:center;">
                <span style="font-weight:bold; font-size:13px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span>
                <button class="btn-len" onclick="setLen(1, this)">1</button>
                <button class="btn-len" onclick="setLen(2, this)">2</button>
                <button class="btn-len" onclick="setLen(3, this)">3</button>
                <button class="btn-len" onclick="setLen(4, this)">4</button>
                <button class="btn-len active" onclick="setLen(5, this)">5</button>
                <button class="btn-len" onclick="setLen(6, this)">6</button>
                <button class="btn-len" onclick="setLen(7, this)">7</button>
                <button class="btn-len" onclick="setLen(8, this)">8</button>
                <button class="btn-len" onclick="setLen(9, this)">9</button>
            </div>
        </div>

       <div class="grid-targets">
            <button class="btn-target" onclick="setTarget('hundred', this)">üíØ ‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢</button>
            <button class="btn-target" onclick="setTarget('tens_up', this)">‚¨ÜÔ∏è ‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</button>
            <button class="btn-target" onclick="setTarget('units_up', this)">‚ÜóÔ∏è ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô</button>
            <button class="btn-target" onclick="setTarget('tens_down', this)">‚¨áÔ∏è ‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á</button>
            <button class="btn-target" onclick="setTarget('units_down', this)">‚ÜòÔ∏è ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á</button>
            <button class="btn-target active" style="color:var(--p); border-color:var(--p);" onclick="setTarget('tf_up', this)">üé≤ ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô</button>
            <button class="btn-target" style="color:var(--p); border-color:var(--p);" onclick="setTarget('tf_down', this)">üé≤ ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á</button>
            <button class="btn-target" style="color:#6610f2; border-color:#6610f2;" onclick="setTarget('pair_up', this)">üçí ‡∏ß‡∏¥‡∏ô‡∏ö‡∏ô</button>
            <button class="btn-target" style="color:#6610f2; border-color:#6610f2;" onclick="setTarget('pair_down', this)">üçí ‡∏ß‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á</button>
            <button class="btn-target" style="color:#dc3545; border-color:#dc3545;" onclick="setTarget('any_no_hundred', this)">üé≤ ‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á</button>
        </div>

        <button class="btn-add" style="background:var(--p); width:200px; display:block; margin:0 auto;" onclick="runProgram()">üöÄ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</button>
    </div>

    <div id="loading" style="text-align:center; padding:20px; display:none; color:#888;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    <div class="table-wrapper" id="tableWrapper" style="display:none;"><div id="resultContainer"></div></div>
    
    <div id="tableFooterControls" class="table-footer-controls">
        <button class="page-btn" onclick="changePage(-1)">‚ùÆ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <span id="pageInfo" class="page-info">1-10</span>
        <button class="page-btn" onclick="changePage(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ùØ</button>
    </div>

    <div id="consensusSection" class="consensus-box" style="display:none; margin-top:20px; padding:15px; background:#fff7ed; border:2px solid #fdba74; border-radius:15px; text-align:center;">
        <div style="font-size:20px; font-weight:800; color:#9a3412; margin-bottom:10px;">üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏•‡∏Ç‡∏ä‡∏ô</div>
        <div id="consensusContent" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;"></div>
    </div>
    
    <div class="collapsible-container">
        <div class="collapsible-header" onclick="toggleSection('dashAnalytics', 'dashIcon1')">
            <span>üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• (Flow & Structure)</span><span id="dashIcon1">‚ñº</span>
        </div>
        <div id="dashAnalytics" class="collapsible-content">
            <div class="dashboard-grid">
                <div class="flow-section" id="flowPanel" style="display:none;">
                    <div class="label-head" style="justify-content:center;">üåä ‡πÄ‡∏•‡∏Ç‡πÑ‡∏´‡∏• (Flow 10 ‡∏´‡∏•‡∏±‡∏Å)</div>
                    <div id="flowGridWrapper" class="flow-grid-wrapper"></div>
                </div>
                <div class="structure-section" id="structurePanel" style="display:none;">
                    <div class="label-head" style="justify-content:center;">üìä ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (Structure)</div>
                    <div id="structGridWrapper" class="struct-grid-wrapper"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="collapsible-container" id="vinFlowSection" style="margin-top: 20px; display:none;">
        <div class="collapsible-header" onclick="toggleSection('vinFlowContent', 'vinFlowIcon')">
            <span>üí∞ ‡∏à‡∏±‡∏ö‡∏ß‡∏¥‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏´‡∏• (Auto Flow Vin)</span>
            <span id="vinFlowIcon">‚ñº</span>
        </div>
        <div id="vinFlowContent" class="collapsible-content">
            <div style="background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 14px; font-weight: 700; color: var(--txt-l);">‚úÇÔ∏è ‡∏ï‡∏±‡∏î‡∏Å‡∏µ‡πà‡∏ï‡∏±‡∏ß:</span>
                    <input type="number" id="vinFlowLimit" value="5" min="2" max="9" onchange="calcVinFlow()" style="width:50px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; text-align: center;"> 
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 14px; font-weight: 700; color: var(--txt-l);">üö´ ‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°:</span>
                    <input type="text" id="vinFlowSumKill" placeholder="‡πÄ‡∏ä‡πà‡∏ô 05" onkeyup="calcVinFlow()" style="width:70px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; text-align: center;">
                </div>
            </div>
            <div class="vin-grid">
                <div class="vin-box">
                    <div class="vin-head bg-vin-up"><span>üçí ‡∏ß‡∏¥‡∏ô‡∏ö‡∏ô</span><button class="btn-tiny" onclick="copyFlowVin('up')">Copy</button></div>
                    <div id="vinFlowUpContent" class="vin-body">...</div>
                </div>
                <div class="vin-box">
                    <div class="vin-head bg-vin-down"><span>üçí ‡∏ß‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á</span><button class="btn-tiny" onclick="copyFlowVin('down')">Copy</button></div>
                    <div id="vinFlowDownContent" class="vin-body">...</div>
                </div>
            </div>
        </div>
    </div>

    <div style="height:50px;"></div>
    <div id="toast" class="toast">‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</div>
    <input type="hidden" id="manualLimitInput" value="100">
</div>

<div class="collapsible-container" style="margin-top: 20px;">
    <div class="collapsible-header" onclick="toggleSection('specialContent', 'specialIcon')">
        <span>üß© ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏ö & ‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (Special Analysis)</span><span id="specialIcon">‚ñº</span>
    </div>
    <div id="specialContent" class="collapsible-content">
        <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
            <button class="sf-btn" style="background:#ef4444; box-shadow:0 4px 10px rgba(239, 68, 68, 0.3);" onclick="calcKillerDigits()">üíÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏ö (Killer)</button>
            <button class="sf-btn" style="background:#8b5cf6; box-shadow:0 4px 10px rgba(139, 92, 246, 0.3);" onclick="checkSpecialPatterns()">üîÑ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ö‡∏¥‡πâ‡∏•/‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á/‡∏´‡∏≤‡∏°</button>
        </div>
        <div id="killerOutput" style="display:none; margin-bottom:20px; animation: fadeIn 0.5s;"></div>
        <div id="patternOutput" style="display:none; animation: fadeIn 0.5s;"></div>
        <div id="fixedRangeOutput" style="display:none; margin-top:20px; animation: fadeIn 0.5s;"></div>
    </div>
</div>

<div class="collapsible-container" style="margin-top: 20px;">
    <div class="collapsible-header" onclick="toggleSection('garlandContent', 'garlandIcon')">
        <span>üå∏ ‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏π‡∏ï‡∏£ (Garland Matrix 10 ‡∏ó‡∏¥‡∏®)</span><span id="garlandIcon">‚ñº</span>
    </div>
    <div id="garlandContent" class="collapsible-content">
        <div style="display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
            <div style="display:flex; align-items:center; gap:5px; background:#f1f5f9; padding:5px 10px; border-radius:10px; border:1px solid #cbd5e1;">
                <span style="font-weight:bold; color:#475569; font-size:13px;">‡∏£‡∏∞‡∏ö‡∏ö:</span>
                <select id="glSystemType" class="btn" style="padding:2px 5px; border:1px solid #cbd5e1; color:#0f172a; font-weight:bold;" onchange="calcGarlandMatrix()">
                    <option value="standard">1. ‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏•‡∏±‡∏¢ (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 10 ‡∏ó‡∏¥‡∏®)</option>
                    <option value="parity">2. ‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏•‡∏±‡∏¢ (‡∏Ñ‡∏π‡πà/‡∏Ñ‡∏µ‡πà +0/+1)</option>
                </select>
            </div>
            <div style="display:flex; align-items:center; gap:5px; background:#f1f5f9; padding:5px 10px; border-radius:10px; border:1px solid #cbd5e1;">
                <span style="font-weight:bold; color:#475569; font-size:13px;">‡πÄ‡∏î‡∏¥‡∏ô:</span>
                <select id="glLen" class="btn" style="padding:2px 5px; border:1px solid #cbd5e1;" onchange="calcGarlandMatrix()">
                    <option value="1">1 ‡∏ï‡∏±‡∏ß</option>
                    <option value="2">2 ‡∏ï‡∏±‡∏ß</option>
                    <option value="3">3 ‡∏ï‡∏±‡∏ß</option>
                    <option value="4">4 ‡∏ï‡∏±‡∏ß</option>
                    <option value="5">5 ‡∏ï‡∏±‡∏ß</option>
                    <option value="6">6 ‡∏ï‡∏±‡∏ß</option>
                    <option value="7">7 ‡∏ï‡∏±‡∏ß</option>
                    <option value="8">8 ‡∏ï‡∏±‡∏ß</option>
                    <option value="9">9 ‡∏ï‡∏±‡∏ß</option>
                </select>
            </div>
            <div style="display:flex; align-items:center; gap:5px; background:#f1f5f9; padding:5px 10px; border-radius:10px; border:1px solid #cbd5e1;">
                <span style="font-weight:bold; color:#475569; font-size:13px;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</span>
                <select id="glTarget" class="btn" style="padding:2px 5px; border:1px solid #cbd5e1;" onchange="calcGarlandMatrix()">
                    <option value="0">1. ‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢</option>
                    <option value="1">2. ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏ö‡∏ô</option>
                    <option value="2">3. ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô</option>
                    <option value="3">4. ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á</option>
                    <option value="4">5. ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á</option>
                    <option value="5" style="color:#059669; font-weight:bold;">6. ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô (‡∏£‡∏π‡∏î)</option>
                    <option value="6" style="color:#059669; font-weight:bold;">7. ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á (‡∏£‡∏π‡∏î)</option>
                    <option value="7" style="color:#db2777; font-weight:bold;">8. ‡∏ß‡∏¥‡∏ô‡∏ö‡∏ô (‡∏Ñ‡∏£‡∏ö2‡∏ï‡∏±‡∏ß)</option>
                    <option value="8" style="color:#2563eb; font-weight:bold;">9. ‡∏ß‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏Ñ‡∏£‡∏ö2‡∏ï‡∏±‡∏ß)</option>
                    <option value="9" style="color:#7c3aed; font-weight:bold;">10. ‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á (‡∏£‡∏ß‡∏°)</option>
                </select>
            </div>
            <button class="sf-btn" style="background:#db2777; box-shadow:0 4px 10px rgba(219, 39, 119, 0.3);" onclick="calcGarlandMatrix()">üå∏ ‡∏£‡∏±‡∏ô‡∏™‡∏π‡∏ï‡∏£</button>
        </div>
        <div id="garlandOutput" style="overflow-x:auto;"></div>
    </div>
</div>

<div class="collapsible-container" style="margin-top: 20px; border: 2px solid #22c55e;">
    <div class="collapsible-header" onclick="toggleSection('wfContent', 'wfIcon')" style="background:#f0fdf4;">
        <span style="color:#15803d;">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Universal Walk-Forward)</span><span id="wfIcon">‚ñº</span>
    </div>
    <div id="wfContent" class="collapsible-content">
        <div class="smart-flow-box" style="margin-top:0; border:none; background:#ffffff;">
            
            <div class="sf-header" style="justify-content:center; flex-wrap:wrap; gap:10px; border-bottom:1px dashed #cbd5e1; padding-bottom:15px; margin-bottom:15px;">
                
                <div style="display:flex; align-items:center; gap:5px; background:#f8fafc; padding:5px 10px; border-radius:8px; border:1px solid #cbd5e1;">
                    <span style="font-size:14px; color:#334155; font-weight:bold;">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö:</span>
                    <select id="wfStrategyType" class="btn" style="padding:4px; font-weight:bold; color:#15803d; border:1px solid #22c55e;">

                            <option value="garland">üå∏ ‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏•‡∏±‡∏¢ (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</option>
                            <option value="garland_parity">üå∏ ‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏•‡∏±‡∏¢ (‡∏Ñ‡∏π‡πà/‡∏Ñ‡∏µ‡πà Base+0/+1)</option>
                        </optgroup>
                
                    </select>
                </div>

                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-size:14px; color:#334155; font-weight:bold;">2. ‡∏à‡∏≥‡∏•‡∏≠‡∏á:</span>
                    <select id="wfTestCount" class="btn" style="padding:4px;">
                        <option value="20">20 ‡∏á‡∏ß‡∏î</option>
                        <option value="50" selected>50 ‡∏á‡∏ß‡∏î</option>
                        <option value="100">100 ‡∏á‡∏ß‡∏î</option>
                    </select>
                </div>
                
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-size:14px; color:#334155; font-weight:bold;">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</span>
                    <select id="wfLookback" class="btn" style="padding:4px;">
                        <option value="5" selected>5 ‡∏á‡∏ß‡∏î</option>
                        <option value="10">10 ‡∏á‡∏ß‡∏î</option>
                        <option value="20">20 ‡∏á‡∏ß‡∏î</option>
                    </select>
                </div>

                <button class="sf-btn" style="background:#22c55e; box-shadow:0 4px 10px rgba(34, 197, 94, 0.3);" onclick="runUniversalWalkForward()">
                    ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                </button>
            </div>

            <div id="wfResult" style="margin-top:15px; display:none;">
                
                <div id="aiAdviceBox" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold;"></div>

                <div style="display:flex; gap:15px; margin-bottom:15px;">
                    <div style="flex:1; background:white; padding:15px; border-radius:10px; text-align:center; border:1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                        <div style="font-size:12px; color:#64748b; font-weight:bold; margin-bottom:5px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (Win Rate)</div>
                        <div id="wfWinRate" style="font-size:28px; font-weight:900; color:#10b981; line-height:1;">0%</div>
                        <div id="wfWinCount" style="font-size:12px; color:#94a3b8; margin-top:5px;">-</div>
                    </div>
                    <div style="flex:1; background:white; padding:15px; border-radius:10px; text-align:center; border:1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                        <div style="font-size:12px; color:#64748b; font-weight:bold; margin-bottom:5px;">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏° (P/L)</div>
                        <div id="wfProfit" style="font-size:28px; font-weight:900; color:#10b981; line-height:1;">+0</div>
                        <div style="font-size:10px; color:#94a3b8; margin-top:5px;">(‡∏´‡∏ô‡πà‡∏ß‡∏¢)</div>
                    </div>
                </div>

                <div style="background:white; padding:15px; border-radius:10px; border:1px solid #e2e8f0; position:relative;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="font-size:12px; font-weight:bold; color:#334155;">üìà ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏ô (Equity Curve)</div>
                        <div style="font-size:10px; color:#94a3b8;">*‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô = ‡∏î‡∏µ</div>
                    </div>
                    <div id="wfEquityChart" style="display:flex; align-items:flex-end; height:120px; gap:2px; overflow-x:auto; padding-bottom:5px;"></div>
                </div>

                <div id="wfLogContainer" style="margin-top:15px;"></div>
            </div>

        </div>
    </div>
</div>

<script>
    let currentFollowStr = "", currentPairWinStr = "", currentPairTop10Str = "", currentDeepFollowStr = "";
    let currentTarget='tf_up', currentTargetLabel='‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô', currentLen=5, displayMode='auto';
    let inputOrder = 'normal', isHuntingMode = false, sortMode = 'score';
    let currentStepMode = 'normal', currentStepLabel='‡πÄ‡∏£‡∏µ‡∏¢‡∏á (+1)';
    let isHeatmapMode = false, myWorker = null, isEditing = false, pinnedList = [];
    let currentLottoType = 'thai', sessionSeed = Math.floor(Math.random() * 100000);
    let globalFlowData = {}, currentPage = 1, pageSize = 10;
    let lastCalculatedResults = [], globalRawResults = [], currentData = [];

    const workerScript = `
    self.onmessage = function(e) {
        try {
            const { intData, targetType, len, displayMode, startIdx, endIdx, manualLimit, killDigits, isHuntingMode, huntMax, seed, stepMode, page, pageSize, forwardTest } = e.data;
            const targetCount = (displayMode === 'all') ? (manualLimit || 100) : 2000;
            let results = findFormulasLite(intData, targetType, len, displayMode, startIdx, endIdx, targetCount, killDigits, isHuntingMode, huntMax, seed, stepMode, page, pageSize, forwardTest);
            self.postMessage({status:'success', data:results});
        } catch(err) {
            self.postMessage({status:'error', msg:err.message});
        }
    };
    function sfc32(a, b, c, d) { return function() { a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; var t = (a + b) | 0; a = b ^ b >>> 9; b = c + (c << 3) | 0; c = (c << 21 | c >>> 11); d = d + 1 | 0; t = t + d | 0; c = c + t | 0; return (t >>> 0) / 4294967296; } }
    function getAdditives(len, mode) { let arr = []; if (mode === 'step5') { let baseLen = Math.ceil(len / 2); for (let i = 0; i < baseLen; i++) arr.push(i); for (let i = 0; i < baseLen; i++) arr.push((i + 5) % 10); return arr.slice(0, len); } let step = 1; let start = 0; if(mode === 'odd') { start=1; step=2; } else if(mode === 'even') { start=0; step=2; } else if(mode === 'step3') { start=0; step=3; } for(let i=0; i<len; i++) arr.push((start + (i*step)) % 10); return arr; }
    function getTargetValue(roundArr, type) { if (!roundArr) return []; if(type==='hundred') return [roundArr[0]]; if(type==='tens_up') return [roundArr[1]]; if(type==='units_up') return [roundArr[2]]; if(type==='tens_down') return [roundArr[3]]; if(type==='units_down') return [roundArr[4]]; if(type==='tf_up') return [roundArr[1], roundArr[2]]; if(type==='tf_down') return [roundArr[3], roundArr[4]]; if(type==='pair_up') return [roundArr[1], roundArr[2]]; if(type==='pair_down') return [roundArr[3], roundArr[4]]; if(type==='any_no_hundred') return [roundArr[1], roundArr[2], roundArr[3], roundArr[4]]; return []; }
    function checkWin(targets, nums, type) { let match = 0; for (let t of targets) if (nums.includes(t)) match++; if (type.includes('pair')) return match === targets.length; if (type.includes('tf') || type.includes('any')) return match > 0; return match > 0; }
    function findFormulasLite(intData, targetType, len, displayMode, startIdx, endIdx, targetCount, killDigits, isHuntingMode, huntMax, seed, stepMode, page, pageSize, forwardTest) {
        if ((stepMode === 'odd' || stepMode === 'even') && len > 5) len = 5;
        let activeEndIdx = Math.min(endIdx - (forwardTest || 0), intData.length - 1);
        const targetVals = new Array(intData.length).fill(null);
        for(let i=1; i < intData.length; i++) targetVals[i] = getTargetValue(intData[i], targetType);
        let randFunc = Math.random;
        if (displayMode === 'all' || isHuntingMode) { let seedVal = 12345 + (targetType.length * 100) + len; randFunc = sfc32(seedVal, seedVal+1, seedVal+2, seedVal+3); }
        const positions = [0, 1, 2, 3, 4]; const operators = ['+', '-', '*']; const constants = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; 
        let allResults = []; let additives = getAdditives(len, stepMode);
        for (let r = 0; r < targetCount; r++) {
            let p1 = positions[Math.floor(randFunc() * 5)]; let p2 = positions[Math.floor(randFunc() * 5)]; let op = operators[Math.floor(randFunc() * 3)]; let con = constants[Math.floor(randFunc() * 10)]; let m1 = Math.floor(randFunc() * 5) + 1;
            const baseSums = new Int8Array(intData.length);
            for(let i=0; i<intData.length; i++) { let v1 = intData[i][p1]; let v2 = intData[i][p2]; let res = 0; if (op === '+') res = (v1 * m1) + v2; else if (op === '-') res = (v1 * m1) - v2; else if (op === '*') res = (v1 * m1) * v2; if (isNaN(res)) res = 0; baseSums[i] = Math.floor(Math.abs(res) + con) % 10; }
            let name = \`(\${m1>1?m1+'x':''}\${['‡∏£','‡∏™','‡∏ô','‡∏•‡∏™','‡∏•‡∏ô'][p1]} \${op} \${['‡∏£','‡∏™','‡∏ô','‡∏•‡∏™','‡∏•‡∏ô'][p2]}) + \${con}\`;
            for(let start=0; start<=9; start++) {
                let score=0; let currentLoss = 0; let maxCons = 0; let totalLoss = 0; let loopStart = Math.max(1, startIdx);
                for(let i=loopStart; i<=activeEndIdx; i++) { 
                    let sourceIdx = i - 1; let numsToCheck = [];
                    for(let k=0; k<len; k++) numsToCheck.push((baseSums[sourceIdx]+start+additives[k])%10);
                    if (targetVals[i]) { if(checkWin(targetVals[i], numsToCheck, targetType)) { score++; currentLoss = 0; } else { currentLoss++; totalLoss++; if(currentLoss > maxCons) maxCons = currentLoss; } }
                }
                allResults.push({ name: name+" (R"+start+")", score: score, totalLoss: totalLoss, maxCons: maxCons, p1, p2, op, con, m1, start, baseSums, lastProcessedIdx: activeEndIdx });
                if (allResults.length >= targetCount) break;
            }
             if (allResults.length >= targetCount) break;
        }
        allResults.sort((a,b)=>b.score-a.score);
        if (displayMode === 'auto') allResults = allResults.slice(0, 5);
        return allResults.map(res => {
            let history = [];
            let huntState = { active: false, round: 0, nums: [] };
            for(let i=1; i < intData.length; i++) {
                 let sourceIdx = i - 1; let formulaNums = [];
                 for(let k=0; k<len; k++) formulaNums.push((res.baseSums[sourceIdx]+res.start+additives[k])%10);
                 let playNums = formulaNums; let huntRoundInfo = 0;
                 if (isHuntingMode) {
                    if (huntState.active) { playNums = huntState.nums; huntState.round++; huntRoundInfo = huntState.round; } else { playNums = formulaNums; }
                 }
                 let target = getTargetValue(intData[i], targetType);
                 let isWin = checkWin(target, playNums, targetType);
                 let isTest = (i > res.lastProcessedIdx); 
                 let record = { nums: playNums, win: isWin, rowIdx: i, isTest: isTest, huntRound: huntRoundInfo, huntMax: huntMax }; 
                 if (i >= startIdx && i <= endIdx) { history.push(record); }
                 if (isHuntingMode) {
                     if (isWin) { huntState.active = false; huntState.round = 0; huntState.nums = []; } 
                     else { if (huntState.active) { if (huntState.round >= huntMax) { huntState.active = false; huntState.round = 0; huntState.nums = []; } } else { huntState.active = true; huntState.round = 0; huntState.nums = playNums; } }
                 }
            }
            let lastIdx = intData.length - 1; let predNums = [];
            if (isHuntingMode && huntState.active) { predNums = huntState.nums; } else { for(let k=0; k<len; k++) predNums.push((res.baseSums[lastIdx]+res.start+additives[k])%10); }
            let nextHuntRound = (isHuntingMode && huntState.active) ? huntState.round + 1 : 0;
            history.push({ nums: predNums, win: null, rowIdx: -1, isTest: true, huntRound: nextHuntRound, huntMax: huntMax });
            return { name: res.name, score: res.score, totalLoss: res.totalLoss, maxCons: res.maxCons, history: history };
        });
    }`;

    function runProgram() {
        const rawInput = document.getElementById('inputData').value; if(!rawInput.trim()) return;
        updateDbCount(); document.getElementById('loading').style.display='block'; document.getElementById('tableWrapper').style.display='none';
        const parseRes = parseInputText(rawInput);
        if(parseRes.rounds.length < 2) { alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"); document.getElementById('loading').style.display='none'; return; }
        currentData = parseRes.rounds;
        const intData = currentData.map(r => [parseInt(r.up[0]), parseInt(r.up[1]), parseInt(r.up[2]), parseInt(r.down[0]), parseInt(r.down[1])]);
        renderFlowDashboard(intData); calculateStructure(intData); autoFillInputs(); document.getElementById('vinFlowSection').style.display = 'block'; calcVinFlow(); 
        if(!document.getElementById('rangeEnd').value) updateRangeFromCount();
        const params = {
            intData: intData, targetType: currentTarget, len: parseInt(currentLen),
            displayMode: displayMode, startIdx: Math.max(0, (parseInt(document.getElementById('rangeStart').value)||1) - 1),
            endIdx: Math.min(intData.length - 1, (parseInt(document.getElementById('rangeEnd').value)||intData.length) - 1),
            manualLimit: parseInt(document.getElementById('manualLimitInput').value) || 100,
            killDigits: document.getElementById('killDigits').value,
            isHuntingMode: isHuntingMode, huntMax: parseInt(document.getElementById('huntMax').value) || 3, 
            seed: sessionSeed, stepMode: currentStepMode, page: currentPage, pageSize: pageSize, forwardTest: parseInt(document.getElementById('forwardTest').value) || 0 
        };
        if(myWorker) myWorker.terminate(); 
        const blob = new Blob([workerScript], {type: 'application/javascript'});
        myWorker = new Worker(URL.createObjectURL(blob));
        const safetyTimeout = setTimeout(() => { document.getElementById('loading').style.display='none'; if(myWorker) myWorker.terminate(); alert("‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"); }, 300000);
        myWorker.onmessage = function(e) {
            clearTimeout(safetyTimeout);
            if(e.data.status === 'error') { document.getElementById('loading').style.display='none'; console.error(e.data.msg); return; }
            globalRawResults = e.data.data;
            filterAndRender(); calculateBottomConsensus(globalRawResults.slice(0, 5)); 
            document.getElementById('loading').style.display='none'; document.getElementById('tableWrapper').style.display='block'; document.getElementById('consensusSection').style.display='block';
            if(displayMode==='all') document.getElementById('tableFooterControls').style.display = 'flex';
            if(document.getElementById('copyArea')) document.getElementById('copyArea').style.display='block';
        };
        myWorker.postMessage(params);
    }

    function filterAndRender() {
        if (!globalRawResults || globalRawResults.length === 0) return;
        let maxL = document.getElementById('maxLoss').value === "" ? 999 : parseInt(document.getElementById('maxLoss').value);
        let maxC = document.getElementById('maxConsLoss').value === "" ? 999 : parseInt(document.getElementById('maxConsLoss').value);
        let filtered = globalRawResults.filter(f => f.totalLoss <= maxL && f.maxCons <= maxC);
        lastCalculatedResults = filtered;
        let maxPage = Math.ceil(filtered.length / pageSize);
        if (currentPage > maxPage) currentPage = (maxPage > 0 ? maxPage : 1); if (currentPage < 1) currentPage = 1;
        updatePageInfo();
        let startIndex = (currentPage - 1) * pageSize; let endIndex = startIndex + pageSize;
        let pageResults = filtered.slice(startIndex, endIndex);
        if (filtered.length === 0) { document.getElementById('resultContainer').innerHTML = `<div style="text-align:center; padding:20px; color:#dc2626;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>`; } 
        else { renderTable(currentData, pageResults); }
    }

    function renderTable(data, formulas) {
        let pinned = [], unpinned = [];
        formulas.forEach(f => { if(pinnedList.includes(f.name)) pinned.push(f); else unpinned.push(f); });
        let displayFormulas = [...pinned, ...unpinned];
        let html = `<table><thead><tr><th style="min-width:160px; z-index:100; left:0;">‡∏ú‡∏• <button class="btn-tiny" onclick="copyHistoryColumn()" title="Copy Results">Copy</button></th>`;
        displayFormulas.forEach((f,i) => {
            let isPinned = pinnedList.includes(f.name); let wins=0, losses=0;
            f.history.forEach(h => { if(h.win) wins++; else if(h.win===false) losses++; });
            html += `<th style="min-width:140px;"><div style="display:flex; flex-direction:column; align-items:center; gap:4px;"><div style="display:flex; align-items:center; justify-content:center; gap:5px;"><button class="btn-star ${isPinned?'pinned':''}" onclick="togglePin('${f.name}')">‚òÖ</button><span style="font-size:13px; font-weight:bold;">${f.name}</span><button class="btn-copy-col" onclick="copyColumn('${f.name}')">üìã</button></div><div style="font-size:12px; color:var(--txt-l); background:rgba(0,0,0,0.05); padding:2px 10px; border-radius:10px; font-weight:600;"><span style="color:#16a34a;">‡∏ñ‡∏π‡∏Å ${wins}</span> <span style="color:#cbd5e1;">|</span> <span style="color:#dc2626;">‡∏ú‡∏¥‡∏î ${losses}</span></div></div></th>`;
        });
        html += `</tr></thead><tbody>`;
        let hLen = displayFormulas[0].history.length;
        for(let i=0; i<hLen; i++) {
            let item = displayFormulas[0].history[i]; let isPred = (item.win === null); 
            if(isPred) { html += `<tr><td style="background:#fef08a;">üîÆ ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</td>`; } else { let tr = data[item.rowIdx]; html += `<tr><td>${tr.up}-${tr.down}</td>`; }
            displayFormulas.forEach(f => {
                let h = f.history[i]; let d = h.nums.join('');
                if(isPred) {
                    let huntLabel = (isHuntingMode && h.huntRound > 0) ? `<br><span class="hunt-tag wait" style="font-size:10px;">(‡∏ï‡∏≤‡∏° ${h.huntRound}/${h.huntMax})</span>` : "";
                    html += `<td><span style="font-weight:bold; color:var(--p);">${d}</span>${huntLabel}</td>`;
                } else {
                    let mark = h.win ? `<span class="stat-t">‚úì</span>` : `<span class="stat-f">‚úó</span>`;
                    let targets = getTargetsStr(data[item.rowIdx], currentTarget);
                    let numHtml = '';
                    h.nums.forEach(n => { if(targets.includes(n)) numHtml += `<span class="num-match">${n}</span>`; else numHtml += `<span class="num-normal">${n}</span>`; });
                    let huntTag = "";
                    if (isHuntingMode && h.huntRound > 0) { if (h.win) huntTag = `<span class="hunt-tag win">Win!</span>`; else huntTag = `<span class="hunt-tag wait">‡∏ï‡∏≤‡∏° ${h.huntRound}/${h.huntMax}</span>`; }
                    html += `<td class="num-box" style="text-align:center;">${numHtml} ${mark} ${huntTag}</td>`;
                }
            });
            html += `</tr>`;
        }
        html += `</tbody></table>`;
        document.getElementById('resultContainer').innerHTML = html;
    }

    function copyColumn(title) { if (!lastCalculatedResults || lastCalculatedResults.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà' ‡∏Å‡πà‡∏≠‡∏ô"); let formula = lastCalculatedResults.find(f => f.name === title); if(!formula) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏ï‡∏£"); let lottoName = document.getElementById('lottoSelector').options[document.getElementById('lottoSelector').selectedIndex].text.split(' ')[1] || '‡∏´‡∏ß‡∏¢'; let txt = `üìã ‡∏™‡∏π‡∏ï‡∏£: ${title}\nüçô ${lottoName} (‡πÄ‡∏õ‡πâ‡∏≤: ${currentTargetLabel})\n------------------\n`; formula.history.forEach(h => { if (h.win === null) { txt += `------------------\nüîÆ ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: ${h.nums.join('')}\n`; return; } if (!currentData[h.rowIdx]) return; let rowData = currentData[h.rowIdx]; let resStr = `${rowData.up}-${rowData.down}`; let nums = h.nums.join(''); let mark = h.win ? "‚úì" : "‚úó"; txt += `${nums} = ${resStr} ${mark}\n`; }); txt += `\nBy ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç`; copyText(txt); }

    function copyHistoryColumn() { if (!currentData || currentData.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); let limit = parseInt(document.getElementById('rangeCount').value) || currentData.length; let start = Math.max(0, currentData.length - limit); let subset = currentData.slice(start); let txt = "‡∏ú‡∏•\n------------------\n"; subset.forEach(r => { txt += `${r.up}-${r.down}\n`; }); copyText(txt); }
    function getTargetsStr(r, type) { let uH=parseInt(r.up[0]), uT=parseInt(r.up[1]), uU=parseInt(r.up[2]); let dT=parseInt(r.down[0]), dU=parseInt(r.down[1]); if(type==='hundred') return [uH]; if(type==='tens_up') return [uT]; if(type==='units_up') return [uU]; if(type==='tens_down') return [dT]; if(type==='units_down') return [dU]; if(type==='tf_up') return [uT,uU]; if(type==='tf_down') return [dT,dU]; if(type==='pair_up') return [uT,uU]; if(type==='pair_down') return [dT,dU]; if(type==='any_no_hundred') return [uT,uU,dT,dU]; return []; }
    function changeLottoType() { saveCurrentData(); currentLottoType = document.getElementById('lottoSelector').value; loadCurrentData(); updateRenameButton(); }
    function updateRenameButton() { let customName = localStorage.getItem('lottoName_' + currentLottoType); let select = document.getElementById('lottoSelector'); let option = select.querySelector(`option[value="${currentLottoType}"]`); if (customName && option) { let originalText = option.text; let flag = originalText.split(' ')[0]; option.text = flag + ' ' + customName; } }
    function renameLotto() { let newName = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà:", ""); if (newName) { localStorage.setItem('lottoName_' + currentLottoType, newName); updateRenameButton(); } }
    function saveCurrentData() { localStorage.setItem('lottoData_' + currentLottoType, document.getElementById('inputData').value); }

// üî•üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏ö (Killer Digits) - ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ Responsive 100% üî•üî•
    function calcKillerDigits() {
        if (!currentData || currentData.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô");
        
        const intData = currentData.map(r => [
            parseInt(r.up[0]), parseInt(r.up[1]), parseInt(r.up[2]), 
            parseInt(r.down[0]), parseInt(r.down[1])
        ]);

        const flowDefs = [
            {name:"1.‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢", idx:[0], color:"#ef4444"},
            {name:"2.‡∏™‡∏¥‡∏ö‡∏ö‡∏ô", idx:[1], color:"#f97316"},
            {name:"3.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô", idx:[2], color:"#eab308"},
            {name:"4.‡∏ö‡∏ô (‡∏£‡∏ß‡∏°)", idx:[1,2], color:"#84cc16"},
            {name:"5.‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á", idx:[3], color:"#06b6d4"},
            {name:"6.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á", idx:[4], color:"#3b82f6"},
            {name:"7.‡∏•‡πà‡∏≤‡∏á (‡∏£‡∏ß‡∏°)", idx:[3,4], color:"#6366f1"},
            {name:"8.‡∏ö‡∏ô+‡∏•‡πà‡∏≤‡∏á", idx:[1,2,3,4], color:"#a855f7"},
            {name:"9.‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏ô", idx:[1,2], type:'sum', color:"#be185d"},
            {name:"10.‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á", idx:[3,4], type:'sum', color:"#0369a1"}
        ];

        // ‚úÖ ‡πÉ‡∏ä‡πâ Class 'special-grid' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏° 100%
        let html = `<div class="special-grid">`;
        
        flowDefs.forEach(def => {
            let gaps = [];
            for(let d=0; d<=9; d++) {
                let currentGap = 0;
                let found = false;
                for(let i=intData.length-1; i>=0; i--) {
                    let row = intData[i];
                    let match = false;
                    if(def.type === 'sum') {
                        let v1 = row[def.idx[0]];
                        let v2 = row[def.idx[1]];
                        if(!isNaN(v1) && !isNaN(v2)) {
                            if ((v1+v2)%10 === d) match = true;
                        }
                    } else {
                        for(let id of def.idx) {
                            if(row[id] === d) { match = true; break; }
                        }
                    }
                    if(match) { found = true; break; } else { currentGap++; }
                }
                gaps.push({ n: d, gap: currentGap, found: found });
            }
            gaps.sort((a,b) => b.gap - a.gap);
            let top3 = gaps.slice(0, 3);
            let itemsHtml = top3.map(x => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:4px 0;">
                    <span style="font-weight:bold; color:${def.color}; font-size:14px;">‡πÄ‡∏•‡∏Ç ${x.n}</span>
                    <span style="font-size:12px; color:#64748b;">${x.found ? '‡πÄ‡∏ß‡πâ‡∏ô '+x.gap : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å'}</span>
                </div>
            `).join('');
            
            html += `<div class="special-card" style="border-top:3px solid ${def.color};">
                <div style="font-weight:800; color:#1e293b; margin-bottom:8px; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    ${def.name}
                </div>
                ${itemsHtml}
            </div>`;
        });
        html += `</div>`;
        const out = document.getElementById('killerOutput');
        out.innerHTML = html;
        out.style.display = 'block';
    }

    // üî•üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (Special Patterns) - ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ Responsive 100% üî•üî•
    function checkSpecialPatterns() {
        if (!currentData || currentData.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô");
        let limit = 20;
        let start = Math.max(0, currentData.length - limit);
        let subset = currentData.slice(start);
        let doubleCount = 0, siblingCount = 0, sandwichCount = 0;
        let lastDouble = -1, lastSibling = -1, lastSandwich = -1;

        subset.forEach((r, idx) => {
            let u2 = r.up.substring(1,3);
            let d2 = r.down;
            let u3 = r.up;
            if (u2[0]===u2[1] || d2[0]===d2[1]) { doubleCount++; lastDouble = idx; }
            const isSib = (s) => { let a = parseInt(s[0]), b = parseInt(s[1]); return Math.abs(a-b)===1 || (a===0&&b===9) || (a===9&&b===0); };
            if (isSib(u2) || isSib(d2)) { siblingCount++; lastSibling = idx; }
            if (u3[0] === u3[2]) { sandwichCount++; lastSandwich = idx; }
        });
        
        let gapDouble = (lastDouble === -1) ? limit : (limit - 1 - lastDouble);
        let gapSibling = (lastSibling === -1) ? limit : (limit - 1 - lastSibling);
        let gapSandwich = (lastSandwich === -1) ? limit : (limit - 1 - lastSandwich);

        // ‚úÖ ‡πÉ‡∏ä‡πâ Class 'special-grid' ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
        let html = `<div class="special-grid">`;
        
        const createBadge = (title, count, gap, color) => {
            let status = "‡∏õ‡∏Å‡∏ï‡∏¥", statusColor = "#64748b";
            if (gap > 5) { status = "‡∏£‡∏≠‡∏°‡∏≤‡∏ô‡∏≤‡∏ô (‡∏ô‡πà‡∏≤‡∏ï‡∏≤‡∏°)"; statusColor = "#ef4444"; }
            else if (count >= 5) { status = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏´‡∏• (‡∏£‡∏∞‡∏ß‡∏±‡∏á)"; statusColor = "#10b981"; }
            
            return `<div class="special-card" style="border:1px solid ${color}; background:#fff;">
                <div style="font-weight:bold; color:${color}; font-size:16px; margin-bottom:5px;">${title}</div>
                <div style="font-size:32px; font-weight:800; color:#1e293b; margin:5px 0;">${gap} <span style="font-size:12px; font-weight:normal; color:#94a3b8;">‡∏á‡∏ß‡∏î‡∏ï‡∏¥‡∏î</span></div>
                <div style="margin-top:auto;">
                    <span style="font-size:12px; background:${statusColor}; color:white; padding:3px 10px; border-radius:20px;">${status}</span>
                    <div style="font-size:11px; margin-top:5px; color:#64748b;">(‡∏°‡∏≤ ${count}/${limit} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
                </div>
            </div>`;
        };
        html += createBadge("‡πÄ‡∏•‡∏Ç‡πÄ‡∏ö‡∏¥‡πâ‡∏• (11)", doubleCount, gapDouble, "#ec4899");
        html += createBadge("‡πÄ‡∏•‡∏Ç‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á (01)", siblingCount, gapSibling, "#8b5cf6");
        html += createBadge("‡πÄ‡∏•‡∏Ç‡∏´‡∏≤‡∏° (121)", sandwichCount, gapSandwich, "#f59e0b");
        html += `</div>`;
        
        const out = document.getElementById('patternOutput');
        out.innerHTML = html;
        out.style.display = 'block';
    }



// üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏π‡∏ï‡∏£ (Garland Matrix) - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 10 ‡∏ó‡∏¥‡∏® ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏π‡πà/‡∏Ñ‡∏µ‡πà üî•
function calcGarlandMatrix() {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (!currentData || currentData.length < 10) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏á‡∏ß‡∏î)");

    // 2. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    const systemType = document.getElementById('glSystemType').value; // standard ‡∏´‡∏£‡∏∑‡∏≠ parity
    const len = parseInt(document.getElementById('glLen').value);
    const targetMode = parseInt(document.getElementById('glTarget').value); 
    const lookBack = 20; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á

    // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let startIndex = Math.max(0, currentData.length - lookBack - 1);
    const history = currentData.slice(startIndex);

    // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML
    let html = `<div class="garland-wrapper"><table class="garland-table">`;
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Thead) ---
    if (systemType === 'parity') {
        // ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏π‡πà/‡∏Ñ‡∏µ‡πà
        html += `<thead><tr>
            <th>‡∏á‡∏ß‡∏î</th>
            <th>‡∏ú‡∏•</th>
            <th>‡∏ê‡∏≤‡∏ô (Trend)</th>
            <th style="color:#10b981;">üå∏ ‡∏ê‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ô (+0)</th>
            <th style="color:#f59e0b;">‚ö° ‡∏ê‡∏≤‡∏ô‡∏û‡∏•‡∏¥‡∏Å (+1)</th>
        </tr></thead><tbody>`;
    } else {
        // ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (+0 ‡∏ñ‡∏∂‡∏á +9)
        html += `<thead><tr>
            <th>‡∏á‡∏ß‡∏î</th>
            <th>‡∏ú‡∏•</th>
            <th>‡∏ê‡∏≤‡∏ô (Trend)</th>`;
        for(let i=0; i<=9; i++) html += `<th>+${i}</th>`;
        html += `</tr></thead><tbody>`;
    }

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    let maxCols = (systemType === 'parity') ? 2 : 10;
    let rawScores = Array(maxCols).fill(0);      
    let weightedScores = Array(maxCols).fill(0); 

    // ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ê‡∏≤‡∏ô (Seed) ‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏£‡∏≤‡∏°‡∏¥‡∏î
    const getPyramidSeed = (round) => {
        let row1 = [parseInt(round.up[0]), parseInt(round.up[1]), parseInt(round.up[2]), parseInt(round.down[0]), parseInt(round.down[1])];
        if (row1.some(isNaN)) return null;
        // ‡∏¢‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1 -> 2
        let row2 = []; for(let i=0; i<4; i++) row2.push((row1[i] + row1[i+1]) % 10);
        // ‡∏¢‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2 -> 3
        let row3 = []; for(let i=0; i<3; i++) row3.push((row2[i] + row2[i+1]) % 10);
        // ‡∏¢‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3 -> 4 (‡∏¢‡∏≠‡∏î)
        let row4 = []; for(let i=0; i<2; i++) row4.push((row3[i] + row3[i+1]) % 10);
        // ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡∏∑‡∏≠ ‡∏¢‡∏≠‡∏î‡∏ö‡∏ß‡∏Å‡∏Å‡∏±‡∏ô mod 10
        return (row4[0] + row4[1]) % 10;
    };

    let previousSeed = -1; 

    // 5. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (History Rows)
    for (let i = 1; i < history.length; i++) {
        let prevRound = history[i - 1]; // ‡πÉ‡∏ä‡πâ‡∏á‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ê‡∏≤‡∏ô
        let currentRound = history[i];  // ‡πÉ‡∏ä‡πâ‡∏á‡∏ß‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•
        
        let seed = getPyramidSeed(prevRound);
        if (seed === null) continue;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Trend (‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á)
        let trendIcon = ""; let trendColor = "#64748b"; 
        if (previousSeed !== -1) {
            if (seed > previousSeed) { trendIcon = "‚ñ≤"; trendColor = "#10b981"; } 
            else if (seed < previousSeed) { trendIcon = "‚ñº"; trendColor = "#ef4444"; } 
            else { trendIcon = "‚îÅ"; }
        }
        previousSeed = seed;

        // ‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ç‡∏≠‡∏á‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ
        let h = parseInt(currentRound.up[0]), t = parseInt(currentRound.up[1]), u = parseInt(currentRound.up[2]);
        let dt = parseInt(currentRound.down[0]), du = parseInt(currentRound.down[1]);
        
        let targets = [], displayResult = "", isVinMode = false;
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏≤‡∏° Dropdown
        switch (targetMode) {
            case 0: targets=[h]; displayResult=`${h}`; break; 
            case 1: targets=[t]; displayResult=`${t}`; break; 
            case 2: targets=[u]; displayResult=`${u}`; break; 
            case 3: targets=[dt]; displayResult=`${dt}`; break; 
            case 4: targets=[du]; displayResult=`${du}`; break; 
            case 5: targets=[t,u]; displayResult=`${t}${u}`; break; 
            case 6: targets=[dt,du]; displayResult=`${dt}${du}`; break; 
            case 7: targets=[t,u]; displayResult=`${t}${u}`; isVinMode=true; break; 
            case 8: targets=[dt,du]; displayResult=`${dt}${du}`; isVinMode=true; break; 
            case 9: targets=[t,u,dt,du]; displayResult=`${t}${u}/${dt}${du}`; break;
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Row
        html += `<tr>
            <td style="font-size:14px; color:#64748b;">${history.length - i}</td>
            <td style="font-weight:bold;">${displayResult}</td>
            <td style="color:${trendColor}; font-weight:900; background:#f8fafc; font-size:14px; border-right:2px solid #e2e8f0;">
                ${seed} <span style="font-size:10px;">${trendIcon}</span>
            </td>`;

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏π‡∏ï‡∏£ (+0 ‡∏ñ‡∏∂‡∏á +X)
        for (let offset = 0; offset < maxCols; offset++) {
            let numSet = [];
            
            if (systemType === 'parity') {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏π‡πà/‡∏Ñ‡∏µ‡πà ---
                // offset 0 = ‡∏ê‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ô (Parity ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô), offset 1 = ‡∏ê‡∏≤‡∏ô‡∏û‡∏•‡∏¥‡∏Å
                let baseParity = (seed + offset) % 2; 
                if (baseParity === 0) numSet = [0, 2, 4, 6, 8]; 
                else numSet = [1, 3, 5, 7, 9];
            } else {
                // --- ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ---
                // ‡∏ô‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡πá‡∏°‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ (Mod 10)
                let startDigit = (seed + offset) % 10; 
                for (let k = 0; k < len; k++) numSet.push((startDigit + k) % 10);
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡πÅ‡∏û‡πâ‡∏ä‡∏ô‡∏∞
            let isWin = false;
            if (isVinMode) { 
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏≤‡∏¢ (‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏¥‡πâ‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡∏Å‡πÅ‡∏ö‡∏ö)
                let uniqueTargets = [...new Set(targets)]; 
                let matches = numSet.filter(n => uniqueTargets.includes(n)); 
                isWin = (matches.length === uniqueTargets.length); 
            } else { 
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏Å/‡∏£‡∏π‡∏î ‡πÅ‡∏Ñ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 1 ‡∏ï‡∏±‡∏ß‡∏Å‡πá‡∏ä‡∏ô‡∏∞
                isWin = numSet.some(n => targets.includes(n)); 
            }

            // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            if (isWin) {
                rawScores[offset]++;
                // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ‡∏á‡∏ß‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤
                let recencyScore = 1; 
                let dist = history.length - i; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                if (dist <= 5) recencyScore = 3; 
                else if (dist <= 10) recencyScore = 2;
                weightedScores[offset] += recencyScore;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á
            let cellClass = isWin ? "g-cell-win" : ""; 
            let displayStr = "";
            
            if (systemType === 'parity') {
                let parityName = (numSet[0] === 0) ? "‡∏Ñ‡∏π‡πà" : "‡∏Ñ‡∏µ‡πà";
                if (isWin) displayStr = `<span style="font-weight:bold; color:#065f46;">${parityName} <span style="font-size:9px; opacity:0.7;">(${numSet.join('')})</span></span>`;
                else displayStr = `<span style="color:#94a3b8; font-size:13px;">${parityName}</span>`;
            } else {
                // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤
                numSet.forEach(n => { 
                    if (targets.includes(n)) { 
                        // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° ‡πÑ‡∏°‡πà‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏î‡∏á
                        if (isVinMode && !isWin) displayStr += n; 
                        else displayStr += `<span class="g-num-hit">${n}</span>`; 
                    } else { 
                        displayStr += `<span style="opacity:0.6;">${n}</span>`; 
                    } 
                });
            }
            
            html += `<td class="${cellClass}">${displayStr}</td>`;
        }
        html += `</tr>`;
    }

    // 6. ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Future Round)
    let latestRound = history[history.length - 1]; 
    let nextSeed = getPyramidSeed(latestRound);
    let maxWeightedScore = Math.max(...weightedScores);
    
    // Icon ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏á‡∏ß‡∏î‡∏´‡∏ô‡πâ‡∏≤
    let nextTrendIcon = "?", nextTrendColor = "#64748b";
    if (nextSeed !== null && previousSeed !== -1) { 
        if (nextSeed > previousSeed) { nextTrendIcon = "‚ñ≤"; nextTrendColor = "#10b981"; } 
        else if (nextSeed < previousSeed) { nextTrendIcon = "‚ñº"; nextTrendColor = "#ef4444"; } 
        else { nextTrendIcon = "‚îÅ"; } 
    }

    if (nextSeed !== null) {
        html += `<tr style="background:#fff7ed; border-top:2px solid #fdba74; border-bottom:2px solid #fdba74;">
        <td style="color:#d97706; font-weight:900;">‡∏£‡∏≠‡∏ú‡∏•</td>
        <td style="color:#94a3b8; font-style:italic; font-size:12px;">Next</td>
        <td style="color:${nextTrendColor}; font-weight:900; background:#ffe4e6; border:1px solid #fbcfe8;">${nextSeed}</td>`;
        
        for (let offset = 0; offset < maxCols; offset++) {
            let numSet = [];
            if (systemType === 'parity') {
                let baseParity = (nextSeed + offset) % 2;
                numSet = (baseParity === 0) ? [0, 2, 4, 6, 8] : [1, 3, 5, 7, 9];
            } else {
                let startDigit = (nextSeed + offset) % 10; 
                for (let k = 0; k < len; k++) numSet.push((startDigit + k) % 10);
            }

            // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            let isBestCol = (weightedScores[offset] === maxWeightedScore && maxWeightedScore > 0);
            let style = isBestCol ? "color:#d97706; font-weight:900; background:#ffedd5; border:2px solid #fdba74;" : "color:#64748b; opacity:0.8;";
            
            let displayWait = "";
            if (systemType === 'parity') displayWait = (numSet[0] === 0) ? `‡∏Ñ‡∏π‡πà` : `‡∏Ñ‡∏µ‡πà`;
            else displayWait = numSet.join('');

            html += `<td style="${style}">${displayWait}</td>`;
        }
        html += `</tr>`;
    }

    // 7. ‡πÅ‡∏ñ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    html += `<tr style="background:#334155; color:white; font-weight:bold;">
        <td colspan="3" style="border-right:2px solid #475569; position: static !important; font-size:12px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô</td>`;
    
    for(let s=0; s < maxCols; s++) {
        let bg = (weightedScores[s] === maxWeightedScore && maxWeightedScore > 0) ? '#10b981' : 'transparent';
        html += `<td style="background:${bg}; font-size:14px; position: static !important;" title="‡∏ñ‡∏π‡∏Å ${rawScores[s]} ‡∏á‡∏ß‡∏î">${weightedScores[s]}</td>`;
    }
    html += `</tr></tbody></table></div>`;

    // 8. Forecast Card (‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢)
    let bestOffsets = []; 
    weightedScores.forEach((score, idx) => { if(score === maxWeightedScore && maxWeightedScore > 0) bestOffsets.push(idx); });
    
    let forecastHtml = "";
    if (nextSeed !== null) {
        forecastHtml = `<div style="margin-top:10px; border-top: 3px solid #334155; background:white; border-radius: 0 0 10px 10px; padding:15px; text-align:center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:15px;">
            <div style="font-weight:800; color:#334155; font-size:16px; display:flex; align-items:center; gap:5px;">
                üå∏ ‡∏ê‡∏≤‡∏ô‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ: <span style="display:inline-flex; width:30px; height:30px; background:#db2777; color:white; border-radius:50%; align-items:center; justify-content:center; font-size:18px; box-shadow:0 2px 5px rgba(219, 39, 119, 0.4);">${nextSeed}</span>
            </div>
            <div style="font-weight:800; color:${nextTrendColor}; font-size:14px; display:flex; align-items:center; gap:5px; border:1px solid ${nextTrendColor}; padding:2px 10px; border-radius:15px;">
                ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°: ${nextTrendIcon}
            </div>
        </div>
        <div style="font-size:13px; color:#64748b; margin-bottom:10px; font-weight:bold;">‚ú® ‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô)</div>
        <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">`;
        
        bestOffsets.forEach(offset => {
            let label = "", nums = "";
            let badgeColor = "#f97316";
            
            if (systemType === 'parity') {
                label = (offset === 0) ? "‡∏ê‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ô (+0)" : "‡∏ê‡∏≤‡∏ô‡∏û‡∏•‡∏¥‡∏Å (+1)";
                let baseParity = (nextSeed + offset) % 2;
                nums = (baseParity === 0) ? "‡∏Ñ‡∏π‡πà (02468)" : "‡∏Ñ‡∏µ‡πà (13579)";
                badgeColor = (baseParity === 0) ? "#3b82f6" : "#db2777";
            } else {
                label = `‡∏™‡∏π‡∏ï‡∏£ +${offset}`;
                let start = (nextSeed + offset) % 10; 
                let tmp = []; for(let k=0; k<len; k++) tmp.push((start+k)%10);
                nums = tmp.join('');
            }

            forecastHtml += `<div style="background:#fff7ed; border:1px solid #fed7aa; border-radius:12px; padding:10px 15px; text-align:center; min-width:100px; box-shadow:0 2px 4px rgba(0,0,0,0.05); position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; left:0; width:4px; height:100%; background:${badgeColor};"></div>
                <div style="font-size:12px; color:#c2410c; font-weight:bold; margin-bottom:3px;">${label} üî•</div>
                <div style="font-size:20px; font-weight:900; color:#1e293b; letter-spacing:1px;">${nums}</div>
                <div style="font-size:10px; color:#9a3412; margin-top:3px;">Score: ${weightedScores[offset]}</div>
            </div>`;
        });
        forecastHtml += `</div></div>`;
    }

    document.getElementById('garlandOutput').innerHTML = html + forecastHtml;
}





    // üî•üî• Fix: loadCurrentData ‡πÉ‡∏´‡πâ parse ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentData ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏á‡∏µ‡∏¢‡∏ö) üî•üî•
    function loadCurrentData() { 
        const saved = localStorage.getItem('lottoData_' + currentLottoType) || ""; 
        document.getElementById('inputData').value = saved; 
        
        // Parse ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentData ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const parsed = parseInputText(saved);
        currentData = parsed.rounds;
        
        updateDbCount(); 
        updateRenameButton(); 
        if(saved.trim()) { 
            setTimeout(() => { 
                const totalRounds = document.getElementById('rangeEnd').max; 
                if(totalRounds) document.getElementById('rangeEnd').value = totalRounds; 
                updateRangeFromCount(); 
            }, 100); 
        } 
    }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
    function toggleEditData() { const box = document.getElementById('inputData'); const btn = document.getElementById('btnEdit'); isEditing = !isEditing; box.readOnly = !isEditing; if(isEditing) { box.style.borderColor = '#f97316'; btn.innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; btn.style.background = '#16a34a'; box.addEventListener('input', saveCurrentData); } else { box.style.borderColor = '#cbd5e1'; btn.innerText = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; btn.style.background = '#f59e0b'; box.removeEventListener('input', saveCurrentData); saveCurrentData(); if(box.value.trim()) { updateDbCount(); runProgram(); } } }
    function toggleOrder() { inputOrder = inputOrder==='normal'?'reverse':'normal'; document.getElementById('btnOrder').innerText = inputOrder==='normal'?'‚¨á ‡∏õ‡∏Å‡∏ï‡∏¥':'‚¨Ü ‡∏™‡∏•‡∏±‡∏ö'; }
    function toggleSection(contentId, iconId) { const content = document.getElementById(contentId); const icon = document.getElementById(iconId); if(content.style.display === 'none') { content.style.display = 'block'; icon.innerText = '‚ñº'; } else { content.style.display = 'none'; icon.innerText = '‚ñ≤'; } }
    function toggleDashboard() { toggleSection('dashboardContent', 'dashIcon'); }
    document.addEventListener('DOMContentLoaded', () => { if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode'); currentLottoType = 'thai'; document.getElementById('lottoSelector').value = 'thai'; let select = document.getElementById('lottoSelector'); for (let i = 0; i < select.options.length; i++) { let val = select.options[i].value; let custom = localStorage.getItem('lottoName_' + val); if (custom) { let flag = select.options[i].text.split(' ')[0]; select.options[i].text = flag + ' ' + custom; } } const oldData = localStorage.getItem('lottoData'); if(oldData && !localStorage.getItem('lottoData_thai')) { localStorage.setItem('lottoData_thai', oldData); localStorage.removeItem('lottoData'); } loadCurrentData(); });
    function setMode(m) { displayMode=m; updateUI(); runProgram(); }
    function setHunt(h) { isHuntingMode=h; updateUI(); if(isHuntingMode) setMode('all'); else runProgram(); }
    function setTarget(t, btn) { document.querySelectorAll('.btn-target').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); else if(event && event.target) event.target.classList.add('active'); currentTarget = t; const labelMap = { 'hundred':'‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢', 'tens_up':'‡∏™‡∏¥‡∏ö‡∏ö‡∏ô', 'units_up':'‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô', 'tens_down':'‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á', 'units_down':'‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á', 'tf_up':'‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô', 'tf_down':'‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á', 'pair_up':'‡∏ß‡∏¥‡∏ô‡∏ö‡∏ô', 'pair_down':'‡∏ß‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á', 'any_no_hundred':'‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á*' }; currentTargetLabel = labelMap[t] || t; runProgram(); }
    function setStep(mode, btn) { currentStepMode = mode; document.querySelectorAll('.btn-step').forEach(b => b.classList.remove('active')); btn.classList.add('active'); runProgram(); }
    function setLen(n, btn) { currentLen = n; document.querySelectorAll('.btn-len').forEach(b => b.classList.remove('active')); btn.classList.add('active'); runProgram(); }
    function updateUI() { document.getElementById('btnModeAuto').className = displayMode==='auto'?'btn-mode active':'btn-mode'; document.getElementById('btnModeAll').className = displayMode==='all'?'btn-mode active':'btn-mode'; document.getElementById('manualLimitInput').style.display = displayMode==='all'?'inline-block':'none'; document.getElementById('manualControl').style.display = displayMode==='all'?'inline-flex':'none'; document.getElementById('tableFooterControls').style.display = displayMode==='all'?'flex':'none'; document.getElementById('btnHuntOff').className = !isHuntingMode?'btn-hunt active':'btn-hunt'; document.getElementById('btnHuntOn').className = isHuntingMode?'btn-hunt active':'btn-hunt'; document.getElementById('huntInputWrap').style.display = isHuntingMode?'flex':'none'; if(displayMode==='auto') { setSort('score'); document.getElementById('sortFixed').classList.add('disabled'); document.getElementById('sortScore').classList.remove('disabled'); } else { setSort('fixed'); document.getElementById('sortFixed').classList.remove('disabled'); document.getElementById('sortScore').classList.add('disabled'); } }
    function setSort(mode) { sortMode = mode; document.getElementById('sortScore').className = mode==='score'?'btn-sort active':'btn-sort'; document.getElementById('sortFixed').className = mode==='fixed'?'btn-sort active':'btn-sort'; }
    function changePage(delta) { let maxLimit = parseInt(document.getElementById('manualLimitInput').value) || 100; let maxPage = Math.ceil(maxLimit / pageSize); currentPage += delta; if(currentPage < 1) currentPage = 1; if(currentPage > maxPage) currentPage = maxPage; updatePageInfo(); runProgram(); }
    function updatePageInfo() { let start = (currentPage - 1) * pageSize + 1; let end = currentPage * pageSize; let maxLimit = parseInt(document.getElementById('manualLimitInput').value) || 100; if (end > maxLimit) end = maxLimit; document.getElementById('pageInfo').innerText = `${start}-${end}`; }
    function updateDbCount() { const val = document.getElementById('inputData').value.trim(); const parsed = parseInputText(val); const count = parsed.rounds.length; document.getElementById('dbCount').innerText = `‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${count} ‡∏á‡∏ß‡∏î`; document.getElementById('rangeCount').max = count; document.getElementById('rangeStart').max = count; document.getElementById('rangeEnd').max = count; return count; }
    function updateRangeFromCount() { let total = updateDbCount(); let countInput = document.getElementById('rangeCount'); let val = parseInt(countInput.value); if (isNaN(val) || val < 1) { if (val === 0) countInput.value = 1; return; } if (val > total) { countInput.value = total; val = total; } let newStart = Math.max(1, total - val + 1); document.getElementById('rangeStart').value = newStart; document.getElementById('rangeEnd').value = total; runProgram(); }
    function updateCountFromRange() { let total = updateDbCount(); let startInput = document.getElementById('rangeStart'); let endInput = document.getElementById('rangeEnd'); let countInput = document.getElementById('rangeCount'); let start = parseInt(startInput.value); let end = parseInt(endInput.value); if (!isNaN(end) && end > total) { end = total; endInput.value = total; } if (!isNaN(start) && start > total) { start = total; startInput.value = total; } if (!isNaN(start) && !isNaN(end) && start > end) { start = end; startInput.value = end; } if (!isNaN(start) && !isNaN(end)) { let count = end - start + 1; if (count < 1) count = 1; countInput.value = count; runProgram(); } }
    function togglePin(name) { if(pinnedList.includes(name)) pinnedList = pinnedList.filter(n => n !== name); else { if(pinnedList.length >= 5) { alert("‡πÄ‡∏ï‡πá‡∏° 5 ‡∏™‡∏π‡∏ï‡∏£"); return; } pinnedList.push(name); } if(lastCalculatedResults.length > 0) renderTable(currentData, lastCalculatedResults); }
    function copyText(t) { navigator.clipboard.writeText(t).then(()=>{ const el=document.getElementById('toast'); el.style.display='block'; setTimeout(()=>el.style.display='none', 1000); }); }
    function appendAndRun() { const rawNew = document.getElementById('newData').value.trim(); if(rawNew) { const parsed = parseInputText(rawNew); if(parsed.textFormat) { const main = document.getElementById('inputData'); let textToAdd = parsed.textFormat; if (inputOrder === 'reverse') { let lines = parsed.rounds.map(r => `${r.up} ${r.down}`); textToAdd = lines.reverse().join('\n'); main.value = textToAdd + (main.value.trim() ? "\n" + main.value : ""); main.scrollTop = 0; } else { main.value = (main.value.trim() ? main.value + "\n" : "") + textToAdd; main.scrollTop = main.scrollHeight; } document.getElementById('newData').value = ""; updateDbCount(); saveCurrentData(); const totalRounds = document.getElementById('rangeEnd').max; document.getElementById('rangeEnd').value = totalRounds; updateRangeFromCount(); } else { alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç"); } } else { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°"); } }
    function clearAll() { if(confirm("‡∏•‡πâ‡∏≤‡∏á?")) { document.getElementById('inputData').value=""; saveCurrentData(); document.getElementById('resultContainer').innerHTML=""; ['flowPanel','consensusSection','copyArea','tableWrapper','structurePanel','vinFlowSection'].forEach(id => document.getElementById(id).style.display='none'); updateDbCount(); } }
    function parseInputText(text) { let nums = text.match(/\d+/g); if(!nums) return {rounds:[], textFormat:""}; let rounds=[], tempUp=null, idx=1; nums.forEach(n => { if(n.length===5) rounds.push({i:idx++, up:n.substring(0,3), down:n.substring(3,5)}); else if(n.length===3) tempUp=n; else if(n.length===2 && tempUp) { rounds.push({i:idx++, up:tempUp, down:n}); tempUp=null; } }); if(rounds.length) return {rounds:rounds, textFormat:rounds.map(r=>`${r.up} ${r.down}`).join('\n')}; return {rounds:[], textFormat:""}; }

    function genSmartFlow() { if (!currentData || currentData.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô"); const targetType = parseInt(document.getElementById('sfTarget').value); const len = parseInt(document.getElementById('sfLen').value) || 4; const lookback = parseInt(document.getElementById('sfLookback').value) || 15; const targetDefs = [ { id: 0, idx: [0], name: "‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢" }, { id: 1, idx: [1], name: "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏ö‡∏ô" }, { id: 2, idx: [2], name: "‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô" }, { id: 3, idx: [1, 2], name: "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≠‡∏¢)" }, { id: 4, idx: [3], name: "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á" }, { id: 5, idx: [4], name: "‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á" }, { id: 6, idx: [3, 4], name: "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á" }, { id: 7, idx: [1, 2, 3, 4], name: "‡∏ö‡∏ô+‡∏•‡πà‡∏≤‡∏á (‡∏£‡∏ß‡∏°)" }, { id: 8, idx: [1, 2], type: 'sum', name: "‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏ô" }, { id: 9, idx: [3, 4], type: 'sum', name: "‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á" }, { id: 10, idx: [1, 2], type: 'vin', name: "‡∏ß‡∏¥‡∏ô‡∏ö‡∏ô (‡∏Ñ‡∏£‡∏ö 2 ‡∏ï‡∏±‡∏ß)" }, { id: 11, idx: [3, 4], type: 'vin', name: "‡∏ß‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏Ñ‡∏£‡∏ö 2 ‡∏ï‡∏±‡∏ß)" } ]; const selectedTarget = targetDefs[targetType]; const intData = currentData.map(r => [parseInt(r.up[0]), parseInt(r.up[1]), parseInt(r.up[2]), parseInt(r.down[0]), parseInt(r.down[1])]); const getDigitsFromRow = (row) => { let digits = []; if (selectedTarget.type === 'sum') { let v1 = row[selectedTarget.idx[0]]; let v2 = row[selectedTarget.idx[1]]; if (!isNaN(v1) && !isNaN(v2)) digits.push((v1+v2)%10); } else { selectedTarget.idx.forEach(idx => { let d = row[idx]; if (!isNaN(d)) digits.push(d); }); } return digits; }; let candidates = []; function getCombinations(k) { let result = []; let set = [0,1,2,3,4,5,6,7,8,9]; function backtrack(start, current) { if (current.length === k) { result.push([...current]); return; } for (let i = start; i < set.length; i++) { current.push(set[i]); backtrack(i + 1, current); current.pop(); } } backtrack(0, []); return result; } let allCombos = getCombinations(len); let scored = []; let startTest = Math.max(0, currentData.length - lookback); allCombos.forEach(digits => { let wins = 0; let total = 0; let historyHtml = ""; let historyText = ""; for(let i=startTest; i<currentData.length; i++) { let row = intData[i]; let rowDigits = getDigitsFromRow(row); let hit = false; if (selectedTarget.type === 'vin') { let matches = 0; rowDigits.forEach(d => { if(digits.includes(d)) matches++; }); if(matches >= rowDigits.length && rowDigits.length > 0) hit = true; } else { hit = rowDigits.some(d => digits.includes(d)); } if(hit) wins++; total++; let numsStr = ""; digits.forEach(d => { if (rowDigits.includes(d)) numsStr += `<span class="num-match">${d}</span>`; else numsStr += d; }); let mark = hit ? `<span class="stat-t">‚úì</span>` : `<span class="stat-f">‚úó</span>`; historyHtml += `<div class="row-line"><span>${numsStr}</span> <span>${mark}</span></div>`; let r3 = currentData[i].up; let r2 = currentData[i].down; historyText += `${digits.join('')} = ${r3}-${r2} ${hit ? "‚úì" : "‚úó"}\n`; } scored.push({ key: digits.join(''), wins, total, historyHtml, historyText }); }); scored.sort((a, b) => b.wins - a.wins); let lottoName = document.getElementById('lottoSelector').options[document.getElementById('lottoSelector').selectedIndex].text.split(' ')[1] || '‡∏´‡∏ß‡∏¢'; let gridHtml = ""; scored.slice(0, 5).forEach((c, idx) => { let percent = Math.round((c.wins/c.total)*100); let icon = idx===0?"ü•á":(idx===1?"ü•à":(idx===2?"ü•â":"üéñÔ∏è")); let fullText = `üçô ${lottoName} ‡πÑ‡∏´‡∏•${selectedTarget.name} ${c.key}\n--------------\n${c.historyText}\n${c.key}\n--------------\n‡∏ñ‡∏π‡∏Å ${c.wins}/${c.total} (${percent}%)`; gridHtml += `<div class="sf-card"><div class="sf-card-header"><span>${icon} ‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà ${idx+1}</span><button class="btn-copy-sf" onclick="copySingleSmartFlow(this)" data-text="${fullText}">Copy</button></div><div class="sf-card-body">${c.historyHtml}</div><div class="sf-card-footer"><span style="font-weight:bold; color:var(--p); font-size:16px;">${c.key}</span><span style="font-size:12px; color:${percent>=80?'#16a34a':'var(--txt-l)'}">‡∏ñ‡∏π‡∏Å ${c.wins}/${c.total} (${percent}%)</span></div></div>`; }); document.getElementById('sfOutput').innerHTML = gridHtml; }
    function calculateStructure(intData) { const subset = intData.slice(-10); let html = ""; const defs = [{name:"‡∏£‡πâ‡∏≠‡∏¢", idx:[0], cls:"bg-hundred"},{name:"‡∏™‡∏¥‡∏ö‡∏ö‡∏ô", idx:[1], cls:"bg-tens-up"},{name:"‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô", idx:[2], cls:"bg-units-up"},{name:"‡∏ö‡∏ô (‡∏£‡∏ß‡∏°)", idx:[1,2], cls:"bg-up-all"},{name:"‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á", idx:[3], cls:"bg-tens-down"},{name:"‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á", idx:[4], cls:"bg-units-down"},{name:"‡∏•‡πà‡∏≤‡∏á (‡∏£‡∏ß‡∏°)", idx:[3,4], cls:"bg-down-all"},{name:"‡∏ö‡∏ô+‡∏•‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≠‡∏¢)", idx:[1,2,3,4], cls:"bg-all"}]; defs.forEach(d => { let c=0, odd=0, even=0, high=0, low=0; subset.forEach(r => { d.idx.forEach(i=>{ if(!isNaN(r[i])) { c++; if(r[i]%2!==0) odd++; else even++; if(r[i]>=5) high++; else low++; } }); }); let oS = odd > even ? '<span style="color:#f59e0b; margin-left:2px;">‚òÖ</span>' : ''; let eS = even > odd ? '<span style="color:#f59e0b; margin-left:2px;">‚òÖ</span>' : ''; let hS = high > low ? '<span style="color:#f59e0b; margin-left:2px;">‚òÖ</span>' : ''; let lS = low > high ? '<span style="color:#f59e0b; margin-left:2px;">‚òÖ</span>' : ''; html += `<div class="struct-card"><div class="flow-header ${d.cls}">${d.name}</div><div class="struct-body" style="font-size:16px; font-weight:800; line-height:1.8;"><div style="color:var(--txt);">‡∏Ñ‡∏µ‡πà: ${odd}${oS} <span style="color:#cbd5e1; font-weight:normal; margin:0 5px;">|</span> ‡∏Ñ‡∏π‡πà: ${even}${eS}</div><div style="color:var(--txt); border-top:1px dashed #e2e8f0;">‡∏™‡∏π‡∏á: ${high}${hS} <span style="color:#cbd5e1; font-weight:normal; margin:0 5px;">|</span> ‡∏ï‡πà‡∏≥: ${low}${lS}</div></div></div>`; }); document.getElementById('structGridWrapper').innerHTML = html; document.getElementById('structurePanel').style.display='block'; }
    function renderFlowDashboard(intData) { let html = ''; const defs = [{name:"1.‡∏£‡πâ‡∏≠‡∏¢", idx:[0], cls:"bg-hundred"},{name:"2.‡∏™‡∏¥‡∏ö‡∏ö‡∏ô", idx:[1], cls:"bg-tens-up"},{name:"3.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô", idx:[2], cls:"bg-units-up"},{name:"4.‡∏ö‡∏ô (‡∏£‡∏ß‡∏°)", idx:[1,2], cls:"bg-up-all"},{name:"5.‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á", idx:[3], cls:"bg-tens-down"},{name:"6.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á", idx:[4], cls:"bg-units-down"},{name:"7.‡∏•‡πà‡∏≤‡∏á (‡∏£‡∏ß‡∏°)", idx:[3,4], cls:"bg-down-all"},{name:"8.‡∏ö‡∏ô+‡∏•‡πà‡∏≤‡∏á", idx:[1,2,3,4], cls:"bg-all"},{name:"9.‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏ô", idx:[1,2], type:'sum', cls:"bg-sum-top"},{name:"10.‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏á", idx:[3,4], type:'sum', cls:"bg-sum-bot"}]; defs.forEach(d=>{ let counts = Array(10).fill(0); intData.forEach(r=>{ if(d.type==='sum') { if(!isNaN(r[d.idx[0]])) counts[(r[d.idx[0]]+r[d.idx[1]])%10]++; } else { d.idx.forEach(i=>{ if(!isNaN(r[i])) counts[r[i]]++ }); } }); let sorted = counts.map((c,n)=>({n,c})).sort((a,b)=>b.c-a.c).map(x=>x.n).join(''); html += `<div class="flow-card"><div class="flow-header ${d.cls}">${d.name}</div><div class="flow-body"><div class="flow-num-row">${sorted}</div></div></div>`; if(!d.type) globalFlowData[d.cls] = sorted.split(''); }); document.getElementById('flowGridWrapper').innerHTML=html; document.getElementById('flowPanel').style.display='block'; }
    function calculateBottomConsensus(formulas) { if(!formulas.length) return; let source = displayMode==='auto' ? formulas.slice(0,5) : formulas; let counts = Array(10).fill(0); source.forEach(f => { if(f.history.length) f.history[f.history.length-1].nums.forEach(n => counts[n]++) }); let html = ''; counts.map((c,n)=>({n,c})).sort((a,b)=>b.c-a.c).forEach(x => { if(x.c>0) html+=`<div class="hit-item"><div class="hit-badge" style="background:#f97316;width:40px;height:40px;border-radius:50%;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">${x.n}</div><div style="font-size:12px;margin-top:5px;">‡∏ä‡∏ô ${x.c}</div></div>` }); document.getElementById('consensusContent').innerHTML = html; }
    function calcVinFlow() { let limit = parseInt(document.getElementById('vinFlowLimit').value)||5; let killVal = document.getElementById('vinFlowSumKill').value.trim(); let killSum = killVal ? killVal.replace(/[^0-9]/g, '').split('').map(Number) : []; let tUp = globalFlowData['bg-tens-up'] ? globalFlowData['bg-tens-up'].slice(0, limit) : []; let uUp = globalFlowData['bg-units-up'] ? globalFlowData['bg-units-up'].slice(0, limit) : []; let tDown = globalFlowData['bg-tens-down'] ? globalFlowData['bg-tens-down'].slice(0, limit) : []; let uDown = globalFlowData['bg-units-down'] ? globalFlowData['bg-units-down'].slice(0, limit) : []; const genPairs = (t, u) => { let arr = []; if (!t || !u) return []; t.forEach(tens => { u.forEach(units => { let pair = tens + "" + units; let sum = (parseInt(tens) + parseInt(units)) % 10; if (killSum.length === 0 || !killSum.includes(sum)) arr.push(pair); }); }); return arr.sort((a,b) => parseInt(a) - parseInt(b)); }; window.currentVinUpArr = genPairs(tUp, uUp); window.currentVinDownArr = genPairs(tDown, uDown); window.currentVinLimit = limit; const renderBox = (arr, tens, units) => { let header = `<div style="margin-bottom:8px; color:var(--txt-l); font-size:14px; font-weight:bold;">‡∏™‡∏¥‡∏ö: <span style="color:var(--p)">${tens.join('')}</span> | ‡∏´‡∏ô‡πà‡∏ß‡∏¢: <span style="color:var(--p)">${units.join('')}</span></div>`; if(!arr.length) return header + "..."; let lines = []; for (let i = 0; i < arr.length; i += limit) lines.push(arr.slice(i, i + limit).join(' - ')); let footer = `<div style="margin-top:8px; font-size:12px; color:var(--txt-l); opacity:0.8;">(${arr.length} ‡∏ä‡∏∏‡∏î)</div>`; return header + `<div style="border-top:1px dashed var(--border); padding-top:10px; line-height:1.8;">${lines.join('<br>')}</div>` + footer; }; document.getElementById('vinFlowUpContent').innerHTML = renderBox(window.currentVinUpArr, tUp, uUp); document.getElementById('vinFlowDownContent').innerHTML = renderBox(window.currentVinDownArr, tDown, uDown); }
    function copyFlowVin(type) { let arr = (type === 'up') ? window.currentVinUpArr : window.currentVinDownArr; let label = (type === 'up') ? '‡∏ß‡∏¥‡∏ô‡∏ö‡∏ô' : '‡∏ß‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á'; if (!arr || arr.length === 0) return; let limit = window.currentVinLimit || 5; let total = arr.length; let formattedContent = ""; for (let i = 0; i < arr.length; i += limit) formattedContent += arr.slice(i, i + limit).join(' - ') + "\n"; let txt = `${label}‡∏ï‡∏£‡∏á ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${total} ‡∏ï‡∏±‡∏ß\n------------------\n${formattedContent}\n‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ ‡∏ñ‡∏π‡∏Å‡∏´‡∏ß‡∏¢`; copyText(txt); }
    function copySingleSmartFlow(btn) { copyText(btn.getAttribute('data-text')); }
    function copySmartFlow() { let cards = document.querySelectorAll('.btn-copy-sf'); let allText = ""; cards.forEach(btn => { allText += btn.getAttribute('data-text') + "\n\n====================\n\n"; }); if(allText) copyText(allText); }

    function calcFollowing() {
        if (!currentData || currentData.length < 5) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");
        const targetNum = parseInt(document.getElementById('followNum').value);
        const sPos = parseInt(document.getElementById('sourcePos').value);
        const tPos = parseInt(document.getElementById('targetPos').value);
        const lookForwardInput = document.getElementById('followLookForward');
        const lookForward = lookForwardInput ? (parseInt(lookForwardInput.value) || 3) : 3;
        const getValue = (row, pos) => {
            if (pos <= 4) return parseInt(row[pos]);
            if (pos === 5 && !isNaN(row[1]) && !isNaN(row[2])) return (parseInt(row[1]) + parseInt(row[2])) % 10;
            if (pos === 6 && !isNaN(row[3]) && !isNaN(row[4])) return (parseInt(row[3]) + parseInt(row[4])) % 10;
            return NaN;
        };
        const intData = currentData.map(r => [parseInt(r.up[0]), parseInt(r.up[1]), parseInt(r.up[2]), parseInt(r.down[0]), parseInt(r.down[1])]);
        let counts = Array(10).fill(0); let foundCount = 0; let totalSamples = 0; let highCount = 0, lowCount = 0; let evenCount = 0, oddCount = 0;  
        for (let i = lookForward; i < intData.length; i++) {
            let currentDraw = intData[i]; let sVal = getValue(currentDraw, sPos);
            if (!isNaN(sVal) && sVal === targetNum) {
                foundCount++;
                for (let k = 1; k <= lookForward; k++) {
                    let nextDraw = intData[i-k]; if (!nextDraw) continue;
                    let tVal = getValue(nextDraw, tPos);
                    if (!isNaN(tVal)) {
                        counts[tVal]++; totalSamples++;
                        if (tVal >= 5) highCount++; else lowCount++;
                        if (tVal % 2 === 0) evenCount++; else oddCount++;
                    }
                }
            }
        }
        const outputDiv = document.getElementById('followOutput'); const hlDiv = document.getElementById('hlPrediction');
        if (foundCount === 0) { outputDiv.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`; hlDiv.style.display = 'none'; currentFollowStr = ""; return; }
        let highP = Math.round((highCount / totalSamples) * 100); let lowP = 100 - highP; let evenP = Math.round((evenCount / totalSamples) * 100); let oddP = 100 - evenP;
        hlDiv.style.display = 'block';
        hlDiv.innerHTML = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><div style="background:white; padding:10px; border-radius:10px; border:1px solid #e2e8f0; text-align:center;"><div style="font-weight:bold; color:#334155; margin-bottom:5px;">‚ÜïÔ∏è ‡∏™‡∏π‡∏á-‡∏ï‡πà‡∏≥ (‡∏£‡∏∞‡∏¢‡∏∞ ${lookForward} ‡∏á‡∏ß‡∏î)</div><div style="display:flex; height:15px; border-radius:10px; overflow:hidden; margin-bottom:5px;"><div style="width:${lowP}%; background:#f59e0b;"></div><div style="width:${highP}%; background:#10b981;"></div></div><div style="font-size:12px;">‡∏ï‡πà‡∏≥ ${lowP}% | ‡∏™‡∏π‡∏á ${highP}%</div></div><div style="background:white; padding:10px; border-radius:10px; border:1px solid #e2e8f0; text-align:center;"><div style="font-weight:bold; color:#334155; margin-bottom:5px;">üî¢ ‡∏Ñ‡∏π‡πà-‡∏Ñ‡∏µ‡πà (‡∏£‡∏∞‡∏¢‡∏∞ ${lookForward} ‡∏á‡∏ß‡∏î)</div><div style="display:flex; height:15px; border-radius:10px; overflow:hidden; margin-bottom:5px;"><div style="width:${evenP}%; background:#3b82f6;"></div><div style="width:${oddP}%; background:#ec4899;"></div></div><div style="font-size:12px;">‡∏Ñ‡∏π‡πà ${evenP}% | ‡∏Ñ‡∏µ‡πà ${oddP}%</div></div></div><div style="font-size:12px; color:#64748b; margin-top:5px; text-align:center;">(‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${foundCount} ‡∏£‡∏≠‡∏ö x ${lookForward} ‡∏á‡∏ß‡∏î = ${totalSamples} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</div>`;
        let sorted = counts.map((c, n) => ({ n, c })).sort((a, b) => b.c - a.c);
        currentFollowStr = sorted.map(item => item.n).join('');
        let html = "";
        sorted.forEach(item => {
            let percent = Math.round((item.c / totalSamples) * 100); let barColor = '#10b981'; if(percent >= 15) barColor = '#ef4444'; else if(percent >= 10) barColor = '#f59e0b';
            html += `<div style="display:flex; flex-direction:column; align-items:center; gap:5px; padding:5px; border:1px solid #e2e8f0; border-radius:8px; background:#fff;"><div style="font-size:12px; font-weight:bold; color:#64748b;">${percent}%</div><div style="width:100%; height:50px; background:#f1f5f9; border-radius:5px; position:relative; display:flex; align-items:flex-end; justify-content:center;"><div style="width:60%; height:${Math.max(5, percent * 3)}%; background:${barColor}; border-radius:3px 3px 0 0;"></div></div><div style="font-size:18px; font-weight:800; color:#1e293b;">${item.n}</div><div style="font-size:10px; color:#94a3b8;">(${item.c})</div></div>`;
        });
        outputDiv.innerHTML = html;
    }

    function calcPairFollow() {
        currentPairWinStr = ""; currentPairTop10Str = ""; document.getElementById('pairTop10Action').style.display = 'none';
        if (!currentData || currentData.length < 5) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");
        let inputVal = document.getElementById('pairInput').value;
        if(inputVal === '' || inputVal.length < 2) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô 85)");
        let targetPair = parseInt(inputVal);
        let sPos = document.getElementById('pairSourcePos').value;
        let tPos = document.getElementById('pairTargetPos').value;
        let wantLen = parseInt(document.getElementById('winLength').value) || 7;
        const lookForward = parseInt(document.getElementById('pairLookForward').value) || 3;
        const getPair = (row, type) => {
            if(type === 'up') { if(!isNaN(row[1]) && !isNaN(row[2])) return row[1]*10 + row[2]; } else { if(!isNaN(row[3]) && !isNaN(row[4])) return row[3]*10 + row[4]; } return NaN;
        }
        const intData = currentData.map(r => [parseInt(r.up[0]), parseInt(r.up[1]), parseInt(r.up[2]), parseInt(r.down[0]), parseInt(r.down[1])]);
        let counts = Array(100).fill(0); let digitCounts = Array(10).fill(0); let foundCount = 0; let totalSamples = 0; let highCount = 0, lowCount = 0; let evenCount = 0, oddCount = 0;
        for(let i = lookForward; i < intData.length; i++) {
            let cur = getPair(intData[i], sPos);
            if(cur === targetPair) {
                foundCount++;
                for(let k=1; k<=lookForward; k++) {
                    let next = getPair(intData[i-k], tPos);
                    if(!isNaN(next)) {
                        counts[next]++; totalSamples++;
                        let d1 = Math.floor(next / 10); let d2 = next % 10; digitCounts[d1]++; digitCounts[d2]++;
                        if(next >= 50) highCount++; else lowCount++; if(next % 2 === 0) evenCount++; else oddCount++;
                    }
                }
            }
        }
        const outputDiv = document.getElementById('pairOutput'); const hlDiv = document.getElementById('pairHlPrediction'); const winDiv = document.getElementById('pairWinPrediction');
        if (foundCount === 0) { outputDiv.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏π‡πà ${targetPair}</div>`; hlDiv.style.display = 'none'; winDiv.style.display = 'none'; return; }
        let sortedDigits = digitCounts.map((c, n) => ({ n, c })).sort((a, b) => b.c - a.c);
        let mainSet = sortedDigits.slice(0, wantLen).map(x => x.n);
        currentPairWinStr = mainSet.join('');
        winDiv.style.display = 'grid';
        winDiv.innerHTML = `<div style="background:white; padding:10px; border-radius:10px; border:1px solid #10b981; box-shadow:0 2px 5px rgba(0,0,0,0.05);"><div style="font-weight:bold; color:#059669; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;"><span>üéØ ‡∏ß‡∏¥‡∏ô‡πÑ‡∏´‡∏• (${wantLen} ‡∏ï‡∏±‡∏ß) - ‡∏£‡∏∞‡∏¢‡∏∞ ${lookForward} ‡∏á‡∏ß‡∏î</span></div><div style="font-size:20px; font-weight:800; color:#1e293b; letter-spacing:4px; text-align:center; margin:8px 0;">${mainSet.join('')}</div><div style="font-size:12px; color:#64748b; text-align:center;">(‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏™‡∏∞‡∏™‡∏° ${totalSamples} ‡∏ä‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</div></div>`;
        let highP = Math.round((highCount / totalSamples) * 100); let lowP = 100 - highP; let evenP = Math.round((evenCount / totalSamples) * 100); let oddP = 100 - evenP;
        hlDiv.style.display = 'block';
        hlDiv.innerHTML = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><div style="background:white; padding:10px; border-radius:10px; border:1px solid #e2e8f0; text-align:center;"><div style="font-weight:bold; color:#334155; margin-bottom:5px;">‚ÜïÔ∏è ‡∏™‡∏π‡∏á-‡∏ï‡πà‡∏≥ (‡∏£‡∏ß‡∏°)</div><div style="display:flex; height:15px; border-radius:10px; overflow:hidden; margin-bottom:5px;"><div style="width:${lowP}%; background:#f59e0b;"></div><div style="width:${highP}%; background:#10b981;"></div></div><div style="font-size:12px;">‡∏ï‡πà‡∏≥ ${lowP}% | ‡∏™‡∏π‡∏á ${highP}%</div></div><div style="background:white; padding:10px; border-radius:10px; border:1px solid #e2e8f0; text-align:center;"><div style="font-weight:bold; color:#334155; margin-bottom:5px;">üî¢ ‡∏Ñ‡∏π‡πà-‡∏Ñ‡∏µ‡πà (‡∏£‡∏ß‡∏°)</div><div style="display:flex; height:15px; border-radius:10px; overflow:hidden; margin-bottom:5px;"><div style="width:${evenP}%; background:#3b82f6;"></div><div style="width:${oddP}%; background:#ec4899;"></div></div><div style="font-size:12px;">‡∏Ñ‡∏π‡πà ${evenP}% | ‡∏Ñ‡∏µ‡πà ${oddP}%</div></div></div>`;
        let sorted = counts.map((c, n) => ({ n, c })).sort((a, b) => b.c - a.c).slice(0, 10);
        let top10Nums = sorted.filter(i => i.c > 0).map(i => i.n.toString().padStart(2, '0'));
        currentPairTop10Str = top10Nums.join(', ');
        if(top10Nums.length > 0) { document.getElementById('pairTop10Action').style.display = 'flex'; }
        let html = "";
        sorted.forEach(item => {
            if(item.c === 0) return;
            let pairStr = item.n.toString().padStart(2, '0'); let percent = Math.round((item.c / totalSamples) * 100);
            html += `<div style="text-align:center; padding:5px; border:1px solid #e2e8f0; border-radius:8px; background:#fff;"><div style="font-size:18px; font-weight:bold; color:#059669;">${pairStr}</div><div style="font-size:11px; color:#64748b;">${percent}% (${item.c})</div></div>`;
        });
        outputDiv.innerHTML = html;
    }

    function copyPairTop10() { if(!currentPairTop10Str) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"); copyText(currentPairTop10Str); }
    function copyFollowResult() { if (!currentFollowStr) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå' ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"); return; } copyText(currentFollowStr); }
    function copyPairWinResult() { if (!currentPairWinStr) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"); return; } copyText(currentPairWinStr); }
    function getLatestRound() { if (!currentData || currentData.length === 0) return null; return currentData[currentData.length - 1]; }
    function setFollowFromLatest() { const latest = getLatestRound(); if (!latest) return; const sPos = parseInt(document.getElementById('sourcePos').value); let val = NaN; if (sPos === 0) val = parseInt(latest.up[0]); else if (sPos === 1) val = parseInt(latest.up[1]); else if (sPos === 2) val = parseInt(latest.up[2]); else if (sPos === 3) val = parseInt(latest.down[0]); else if (sPos === 4) val = parseInt(latest.down[1]); else if (sPos === 5) val = (parseInt(latest.up[1]) + parseInt(latest.up[2])) % 10; else if (sPos === 6) val = (parseInt(latest.down[0]) + parseInt(latest.down[1])) % 10; if (!isNaN(val)) { document.getElementById('followNum').value = val; } }
    function setPairFromLatest() { const latest = getLatestRound(); if (!latest) return; const sPos = document.getElementById('pairSourcePos').value; let val = ""; if (sPos === 'up') { val = latest.up.substring(1, 3); } else { val = latest.down; } if (val) { document.getElementById('pairInput').value = val; } }
    function autoFillInputs() {
        if (!currentData || currentData.length === 0) return;
        const latest = currentData[currentData.length - 1]; 
        setFollowFromLatest(); 
        setPairFromLatest();
        const dfPos = parseInt(document.getElementById('dfSourcePos').value);
        let dfVal = null;
        if (dfPos === 0) dfVal = latest.up[0];      
        else if (dfPos === 1) dfVal = latest.up[1]; 
        else if (dfPos === 2) dfVal = latest.up[2]; 
        else if (dfPos === 3) dfVal = latest.down[0]; 
        else if (dfPos === 4) dfVal = latest.down[1]; 
        if (dfVal !== null && !isNaN(dfVal)) { document.getElementById('dfSourceNum').value = parseInt(dfVal); }
    }

    function calcAllStats() {
        // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ (Frequency & Structure)
    }

    // üî•üî• Fix: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å currentData üî•üî•
    function calcDeepFollow() {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (!currentData || currentData.length < 5) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");

        // 2. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const sPos = parseInt(document.getElementById('dfSourcePos').value);
        const sNum = parseInt(document.getElementById('dfSourceNum').value);
        const tPos = parseInt(document.getElementById('dfTargetPos').value);
        
        // 3. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const intData = currentData.map(r => [parseInt(r.up[0]), parseInt(r.up[1]), parseInt(r.up[2]), parseInt(r.down[0]), parseInt(r.down[1])]);
        const getVal = (row, pos) => { if (pos <= 4) return row[pos]; return NaN; };
        
        // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        let counts = Array(10).fill(0); 
        let totalFound = 0;
        for (let i = 1; i < intData.length; i++) {
            let prevRound = intData[i-1]; let currRound = intData[i];
            let prevVal = getVal(prevRound, sPos); let currVal = getVal(currRound, tPos);
            if (!isNaN(prevVal) && prevVal === sNum && !isNaN(currVal)) { counts[currVal]++; totalFound++; }
        }

        // 5. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const headerDiv = document.getElementById('dfResultHeader'); const outputDiv = document.getElementById('dfOutput');
        const posNames = ["‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢", "‡∏™‡∏¥‡∏ö‡∏ö‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô", "‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á", "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á"];
        const sName = posNames[sPos]; const tName = posNames[tPos];

        if (totalFound === 0) { headerDiv.style.display = 'block'; headerDiv.innerHTML = `<span style="color:#ef4444;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ${sName} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç ${sNum}</span>`; outputDiv.innerHTML = ""; currentDeepFollowStr = ""; return; }
        
        headerDiv.style.display = 'block';
        headerDiv.innerHTML = `<div style="color:#334155;">‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${intData.length} ‡∏á‡∏ß‡∏î</div><div style="font-size:18px; margin-top:5px;">‡∏û‡∏ö <span style="color:#059669;">${sName} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç ${sNum}</span> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span style="color:#d97706; font-size:24px;">${totalFound}</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div><div style="color:#64748b; font-size:14px; margin-top:2px;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏•‡∏Ç ${tName} ‡πÉ‡∏ô‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏Ñ‡∏∑‡∏≠:</div>`;
        
        let sorted = counts.map((c, n) => ({ n, c })).sort((a, b) => b.c - a.c);
        let topNums = sorted.filter(x => x.c > 0).map(x => x.n).join('');
        currentDeepFollowStr = `‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å: ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${sName} ‡∏°‡∏≤ ${sNum}\n‡πÄ‡∏•‡∏Ç ${tName} ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏∑‡∏≠: ${topNums}\n(‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ${totalFound} ‡∏£‡∏≠‡∏ö)`;
        
        let html = "";
        sorted.forEach(item => {
            let percent = Math.round((item.c / totalFound) * 100); let barColor = percent >= 15 ? '#ef4444' : (percent >= 10 ? '#f59e0b' : '#10b981');
            if (item.c > 0) {
                html += `<div style="display:flex; flex-direction:column; align-items:center; gap:5px; padding:8px; border:1px solid #e2e8f0; border-radius:8px; background:#fff;"><div style="font-size:12px; font-weight:bold; color:#64748b;">${percent}%</div><div style="width:100%; height:40px; background:#f1f5f9; border-radius:5px; position:relative; display:flex; align-items:flex-end; justify-content:center;"><div style="width:60%; height:${Math.max(10, percent * 3)}%; background:${barColor}; border-radius:3px 3px 0 0;"></div></div><div style="font-size:20px; font-weight:800; color:#1e293b;">${item.n}</div><div style="font-size:11px; color:#94a3b8;">(${item.c})</div></div>`;
            }
        });
        outputDiv.innerHTML = html;
    }

    function copyDeepFollowResult() { if (!currentDeepFollowStr) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô"); copyText(currentDeepFollowStr); }

    // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Walk-Forward (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£ + Log ‡∏™‡∏µ‡πÅ‡∏î‡∏á/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) üî•
    function runUniversalWalkForward() {
        try {
            if (!currentData || currentData.length < 50) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 50 ‡∏á‡∏ß‡∏î)");
            const strategyType = document.getElementById('wfStrategyType').value;
            const testCount = parseInt(document.getElementById('wfTestCount').value);
            const lookback = parseInt(document.getElementById('wfLookback').value);
            const glLen = parseInt(document.getElementById('glLen').value) || 5;
            let glTargetElem = document.getElementById('glTarget');
            const glTarget = glTargetElem ? parseInt(glTargetElem.value) : 1;
            const intData = currentData.map(r => [parseInt(r.up[0]), parseInt(r.up[1]), parseInt(r.up[2]), parseInt(r.down[0]), parseInt(r.down[1])]);
            const getVal = (row, pos) => { if (pos <= 4) return row[pos]; return NaN; };
            let startIndex = currentData.length - testCount;
            if (startIndex < lookback + 1) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á");
            let wins = 0, totalBets = 0, balance = 0;
            let equityCurve = [0];
            let decisionLog = [];

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏°‡∏µ Hunt State ‡πÅ‡∏•‡πâ‡∏ß)
            for (let i = startIndex; i < currentData.length; i++) {
                let pastData = intData.slice(i - lookback, i);
                let currentRound = intData[i];
                let prediction = null, algoName = "", cost = 0, payout = 0;

                // --- 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏π‡∏ï‡∏£ (‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î) ---
                if (strategyType === 'garland_parity') {
                    const getSeed = (r) => { if(r.some(isNaN))return null; let b=[];for(let k=0;k<4;k++)b.push((r[k]+r[k+1])%10); let c=[];for(let k=0;k<3;k++)c.push((b[k]+b[k+1])%10); let d=[];for(let k=0;k<2;k++)d.push((c[k]+c[k+1])%10); return (d[0]+d[1])%10; };
                    const getTargets = (r) => { let t=r; switch(glTarget){case 0:return[t[0]]; case 1:return[t[1]]; case 2:return[t[2]]; case 3:return[t[3]]; case 4:return[t[4]]; default:return[t[2]]; } };
                    let scoreZero = 0, scoreOne = 0;
                    for(let p=0; p<pastData.length; p++) {
                        let prev = (p===0) ? intData[i-lookback-1] : pastData[p-1]; let curr = pastData[p];
                        let seed = getSeed(prev); let tgList = [getTargets(curr)]; 
                        let valCheck = Array.isArray(tgList[0]) ? tgList[0][0] : tgList[0];
                        if(seed === null) continue;
                        if(valCheck % 2 === seed % 2) scoreZero++; else scoreOne++;
                    }
                    let realPrev = intData[i-1]; let realSeed = getSeed(realPrev);
                    if (realSeed !== null) {
                        let playParity = (scoreZero >= scoreOne) ? (realSeed % 2) : ((realSeed + 1) % 2);
                        algoName = (scoreZero >= scoreOne) ? `üå∏ ‡∏ê‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ô (+0)` : `üå∏ ‡∏ê‡∏≤‡∏ô‡∏û‡∏•‡∏¥‡∏Å (+1)`;
                        if (playParity === 0) { prediction = [0, 2, 4, 6, 8]; algoName += " [‡∏Ñ‡∏π‡πà]"; } else { prediction = [1, 3, 5, 7, 9]; algoName += " [‡∏Ñ‡∏µ‡πà]"; }
                        cost = 50; payout = 90;
                    }
                }
                else if (strategyType.startsWith('eo_')) {
                    let pos = 2; let posName = "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô";
                    if (strategyType === 'eo_ten_up') { pos = 1; posName = "‡∏™‡∏¥‡∏ö‡∏ö‡∏ô"; } else if (strategyType === 'eo_unit_up') { pos = 2; posName = "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô"; } else if (strategyType === 'eo_ten_down') { pos = 3; posName = "‡∏™‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏á"; } else if (strategyType === 'eo_unit_down') { pos = 4; posName = "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á"; }
                    let scoreFlow = 0; let scoreSwitch = 0;
                    for(let p=1; p<pastData.length; p++) {
                        let prevVal = getVal(pastData[p-1], pos); let currVal = getVal(pastData[p], pos);
                        if(isNaN(prevVal) || isNaN(currVal)) continue;
                        if ((prevVal % 2) === (currVal % 2)) scoreFlow++; else scoreSwitch++;
                    }
                    let lastVal = getVal(intData[i-1], pos); let lastParity = lastVal % 2;
                    let predictParity = (scoreFlow >= scoreSwitch) ? lastParity : ((lastParity === 0) ? 1 : 0);
                    algoName = `‚òØ ‡∏Ñ‡∏π‡πà/‡∏Ñ‡∏µ‡πà (${posName})`; 
                    if (predictParity === 0) { prediction = [0, 2, 4, 6, 8]; algoName += " [‡∏Ñ‡∏π‡πà]"; } else { prediction = [1, 3, 5, 7, 9]; algoName += " [‡∏Ñ‡∏µ‡πà]"; }
                    cost = 50; payout = 90;
                }
                else if (strategyType === 'garland') {
                    const getSeed = (r) => { if(r.some(isNaN))return null; let b=[];for(let k=0;k<4;k++)b.push((r[k]+r[k+1])%10); let c=[];for(let k=0;k<3;k++)c.push((b[k]+b[k+1])%10); let d=[];for(let k=0;k<2;k++)d.push((c[k]+c[k+1])%10); return (d[0]+d[1])%10; };
                    const getTargets = (r) => { let t=r; switch(glTarget){case 0:return[t[0]];case 1:return[t[1]];case 2:return[t[2]];case 3:return[t[3]];case 4:return[t[4]];case 5:case 7:return[t[1],t[2]];case 6:case 8:return[t[3],t[4]];case 9: return[t[1],t[2],t[3],t[4]]; default:return[t[1],t[2]];} };
                    let scores = Array(10).fill(0);
                    for(let p=0; p<pastData.length; p++) {
                        let prev = (p===0) ? intData[i-lookback-1] : pastData[p-1]; let curr = pastData[p];
                        let seed = getSeed(prev); let tg = getTargets(curr);
                        if(seed===null) continue;
                        for(let off=0; off<=9; off++) {
                            let st = (seed+off)%10; let set=[]; for(let k=0; k<glLen; k++) set.push((st+k)%10);
                            let hit=false; 
                            if([7,8].includes(glTarget)){ let u=[...new Set(tg)]; hit=set.filter(n=>u.includes(n)).length===u.length; } 
                            else if(glTarget === 9) { hit=set.some(n=>tg.includes(n)); } else { hit=set.some(n=>tg.includes(n)); }
                            if(hit) scores[off]++;
                        }
                    }
                    let bestOff = scores.indexOf(Math.max(...scores));
                    let realPrev = intData[i-1]; let seed = getSeed(realPrev);
                    if(seed !== null) {
                        let st = (seed+bestOff)%10; prediction = []; for(let k=0; k<glLen; k++) prediction.push((st+k)%10);
                        algoName = `‡∏™‡∏π‡∏ï‡∏£ +${bestOff}`; payout = 90;
                        if(glTarget <= 4) { cost = glLen * 10; } else if(glTarget === 5 || glTarget === 6) { cost = (20 * glLen) - (glLen * glLen); } else if(glTarget === 7 || glTarget === 8) { cost = glLen * (glLen - 1); } else if(glTarget === 9) { cost = 2 * ((20 * glLen) - (glLen * glLen)); } 
                    }
                }

                // --- 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ---
                if (prediction !== null) {
                    let targets = [];
                    if (strategyType.startsWith('eo_') || strategyType === 'garland_parity') {
                        let pos = 2; if (strategyType === 'eo_ten_up') pos = 1; else if (strategyType === 'eo_ten_down') pos = 3; else if (strategyType === 'eo_unit_down') pos = 4;
                        if(strategyType === 'garland_parity') { switch(glTarget){case 0:pos=0;break; case 1:pos=1;break; case 2:pos=2;break; case 3:pos=3;break; case 4:pos=4;break; default:pos=2;} }
                        targets = [getVal(currentRound, pos)];
                    } else if (strategyType === 'garland') {
                        const getT = (r, m) => { let t=r; switch(glTarget){case 0:return[t[0]];case 1:return[t[1]];case 2:return[t[2]];case 3:return[t[3]];case 4:return[t[4]];case 5:case 7:return[t[1],t[2]];case 6:case 8:return[t[3],t[4]];case 9: return[t[1],t[2],t[3],t[4]]; default:return[t[1],t[2]];} };
                        targets = getT(currentRound, glTarget);
                    }

                    let isWin = false;
                    if (strategyType === 'garland' && [7,8].includes(glTarget)) {
                        let uniqT = [...new Set(targets)]; isWin = prediction.filter(n => uniqT.includes(n)).length === uniqT.length;
                    } else {
                        isWin = prediction.some(n => targets.includes(n));
                    }

                    let pnl = isWin ? (payout - cost) : -cost;
                    balance += pnl; equityCurve.push(balance);
                    if (isWin) wins++; totalBets++;

                    decisionLog.push({ round: totalBets, info: algoName, isWin: isWin, balance: balance, nums: prediction.join('') });
                } else { equityCurve.push(balance); }
            }

            // --- 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
            document.getElementById('wfResult').style.display = 'block';
            let winRate = totalBets > 0 ? Math.round((wins / totalBets) * 100) : 0;
            document.getElementById('wfWinRate').innerText = `${winRate}%`;
            document.getElementById('wfWinRate').style.color = winRate >= 50 ? '#10b981' : '#ef4444';
            document.getElementById('wfWinCount').innerText = `‡∏ñ‡∏π‡∏Å ${wins} / ‡∏ú‡∏¥‡∏î ${totalBets - wins}`;
            let profElem = document.getElementById('wfProfit');
            profElem.innerText = (balance > 0 ? '+' : '') + balance;
            profElem.style.color = balance >= 0 ? '#10b981' : '#dc2626';

            let chartHtml = ""; let minVal = Math.min(...equityCurve), maxVal = Math.max(...equityCurve), range = maxVal - minVal || 1;
            equityCurve.forEach((val, idx) => {
                let h = ((val - minVal) / range) * 80 + 10; let color = val >= 0 ? '#22c55e' : '#ef4444';
                let tip = idx===0 ? "Start" : `#${idx}: ${decisionLog[idx-1]?.isWin?'‚úÖ':'‚ùå'} | ${val}`;
                chartHtml += `<div style="width:100%; background:${color}; height:${h}%; min-width:3px; opacity:0.8; cursor:pointer;" title="${tip}"></div>`;
            });
            document.getElementById('wfEquityChart').innerHTML = chartHtml;

            // --- 4. Log (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Clean ‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á) ---
            let logHtml = `<div style="padding:10px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0;">`;
            logHtml += `<div style="font-size:12px; font-weight:bold; color:#64748b; margin-bottom:8px;">üìú ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏Ç‡∏≠‡∏á AI (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô)</div>`;
            logHtml += `<div style="height:120px; overflow-y:auto; padding-right:5px;">`;
            decisionLog.slice().reverse().forEach(log => {
                let icon = log.isWin ? '‚úì' : '‚úó';
                let iconColor = log.isWin ? '#16a34a' : '#dc2626';
                let balanceColor = log.balance >= 0 ? '#16a34a' : '#dc2626';
                
                logHtml += `<div style="border-bottom:1px dashed #e2e8f0; padding:4px 0; font-size:13px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="color:#334155;">
                        <span style="color:#94a3b8; margin-right:5px;">#${log.round}</span>
                        <span>‡πÉ‡∏ä‡πâ${log.info}</span>
                        <span style="font-family:monospace; margin-left:2px; color:#64748b;">(${log.nums})</span>
                        <span style="margin-left:5px; font-weight:bold; color:${iconColor};">= ${icon}</span>
                    </div>
                    <div style="font-weight:bold; color:${balanceColor};">${log.balance}</div>
                </div>`;
            });
            logHtml += `</div></div>`;
            
            document.getElementById('wfLogContainer').innerHTML = logHtml;

            let adviceHtml = "", adviceColor = "", adviceBg = "";
            if (balance < 0) { adviceBg = "#fee2e2"; adviceColor = "#b91c1c"; adviceHtml = `‚õî ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏•‡∏á (‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô ${balance})<br><span style="font-size:12px; font-weight:normal;">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏π‡∏ï‡∏£</span>`; } 
            else if (winRate < 50) { adviceBg = "#fef3c7"; adviceColor = "#b45309"; adviceHtml = `‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (${winRate}%)<br><span style="font-size:12px; font-weight:normal;">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>`; } 
            else { adviceBg = "#dcfce7"; adviceColor = "#15803d"; adviceHtml = `‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏¢ (+${balance})<br><span style="font-size:12px; font-weight:normal;">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</span>`; }
            let advBox = document.getElementById('aiAdviceBox'); advBox.innerHTML = adviceHtml; advBox.style.backgroundColor = adviceBg; advBox.style.color = adviceColor; advBox.style.border = `1px solid ${adviceColor}`;

        } catch (err) { console.error(err); alert("Error: " + err.message); }
    }
</script>
</body>
</html>
